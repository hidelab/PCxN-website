<!DOCTYPE html>
<html>
<head>
<title>PCxN</title>
<meta charset="utf-8" />
<meta property="og:url"			content="http://pcxn.org:8080/index.html" />
<meta property="og:type"		content="website" />
<meta property="og:title"		content="PCxN The Pathway Co-Activity Map" />
<meta property="og:description"	content="A database for correlation of pathways/gene sets" />
<meta property="og:image"		content="http://pcxn.org:8080/pcxnscreenshot1.png" />
<!-- <meta name="viewport"			content="width=device-width, user-scalable=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, minimal-ui"> -->
<meta name="viewport"			content="width=device-width, user-scalable=no, initial-scale=1.0, minimal-ui">

<!-- Load all .js and .css required -->
<script src="js/canvasXpress.min.js"></script>
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" />
<link rel="stylesheet" href="css/sbg.css" />
<link rel="stylesheet" href="css/buttons.css" />
<script type="text/javascript" src="js/sbg.js"></script>
<link rel="stylesheet" type="text/css" href="css/jquery.dataTables.css">
<script type="text/javascript" src="js/jquery-2.1.1.min.js"></script>
<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
<script type="text/javascript" src="js/jquery.dataTables.min.js"></script>
<link href="shared/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" type="text/css" href="TableTools/css/dataTables.tableTools.css">
<script type="text/javascript" src="TableTools/js/dataTables.tableTools.js"></script>
<link rel="stylesheet" type="text/css" href="pcxn.css">
<script src="js/cytoscape.js"></script>
<script src="js/FileSaver.js"></script>
<script src="js/cola.js"></script>
<script	src="https://cdn.rawgit.com/cytoscape/cytoscape.js-spread/1.0.9/cytoscape-spread.js"></script>
<script src="http://marvl.infotech.monash.edu/webcola/cola.v3.min.js"></script>
<script	src="https://cdn.rawgit.com/cytoscape/cytoscape.js-cola/1.1.1/cytoscape-cola.js"></script>
<script	src="https://cdn.rawgit.com/cytoscape/cytoscape.js-cose-bilkent/1.0.5/cytoscape-cose-bilkent.js"></script>
<script	src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/jquery.autocomplete.js"></script>

<!-- <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/jq-2.2.4/jszip-2.5.0/pdfmake-0.1.18/dt-1.10.13/b-1.2.4/b-colvis-1.2.4/b-flash-1.2.4/b-html5-1.2.4/b-print-1.2.4/cr-1.3.2/fc-3.2.2/fh-3.1.2/kt-2.2.0/r-2.1.0/rr-1.2.0/sc-1.4.2/se-1.2.0/datatables.min.css"> -->
<!-- <script type="text/javascript" src="https://cdn.datatables.net/v/dt/jq-2.2.4/jszip-2.5.0/pdfmake-0.1.18/dt-1.10.13/b-1.2.4/b-colvis-1.2.4/b-flash-1.2.4/b-html5-1.2.4/b-print-1.2.4/cr-1.3.2/fc-3.2.2/fh-3.1.2/kt-2.2.0/r-2.1.0/rr-1.2.0/sc-1.4.2/se-1.2.0/datatables.min.js"></script> -->

<script type="text/javascript">
		
			var pCutOffValue = 0.05;
			var topNValue = 0;
			var formResponse;
			var geneSetsValue;
			var corrCutOffValue = 0.05;
			var geneSetCollectionValue;
			var upGenesetNames = [];
			var downGenesetNames = [];
			var form2geneset = "";
			var pathprintGeneSets = [];
			var mSigDBC2CPGeneSets = [];
			var mSigDBC5GeneSets = [];
		    var mSigDBHGeneSets = [];
			var maxCorrInResponse = 0;
			var minPValueInResponse = 1;
			var maxCorrInResponseWithQuery = 0;
			var minPValueInResponseWithQuery = 1;
			var minCorrInHeatmap = 0;
			var maxCorrInHeatmap = 0;
			var heatmapColors = [];
			var cy = null;
			var cxHeatmap = null;
			var explore = true;
			var activeLayout = 'circle';
			var edgeWidth = 5;
// 			var originDBname = "MSigDBC2CP";
			var originDB = [];
			var availableGenesets;
			
			// Handler for Explore/Analyze decision
			$(document).ready(function(){
								
				$("#navMenu").hide();
// 				document.getElementById("extraSelectCollection").value = localStorage.getItem("currentCollection");
				// Forcing to astrt with Explore
				localStorage.setItem("explore", true);
				// Access current domain's local Storage object. 
				var tmp = localStorage.getItem("explore");
				
    			if (tmp===null) {
                    tmp=="true"
                }
                explore = (tmp=="true");
                sizeCanvas();
                if(explore) {
					$("#form1").hide();
					$("#extraOptions").hide();
				} else {
					$("#form2").hide();
					$("#extraOptions").show();
				}
				$(".result").hide();
    			var parms = {geneSetCollection :"all"};
    			// Get gene sets
				$.getJSON("getAvailableGeneSets.jsp", parms).done(handleAvailableGeneSetsResponse);
			});
				
			// Read what is submitted in the localStorage(user choices), depending on Explore/Analyze
			function checkLocalStorage() {
                //localStorage.clear();
                //alert(explore);
			    var tmp = localStorage.getItem("explore");
    			if (tmp===null) {
                    tmp=="true"
                }
                explore = (tmp=="true");
                
                if (!explore) {
                    document.getElementById("radioAnalysis2").checked = true;
                    tmp = localStorage.getItem("upgenesets");
    				if (tmp !== null) {
        				$("#upgenesets").val(tmp);
    				}
    					
    				tmp = localStorage.getItem("downgenesets");
    				if (tmp !== null) {
        				$("#downgenesets").val(tmp);
    				}
    					
                    tmp = localStorage.getItem("inputTopN");
                    if (tmp===null) {
                        tmp=0;
                    }
                    $("#inputTopN").val(tmp);
    			
                    tmp = localStorage.getItem("inputCorrelation");
                    if (tmp===null) {
                        tmp=0.05;
                    }
                    $("#inputCorrelation").val(tmp);

                    tmp = localStorage.getItem("inputpValue");
                    if (tmp===null) {
                        tmp=0.05
                    } 
                    $("#inputpValue").val(tmp);

                    tmp = localStorage.getItem("selectGeneSetCollection"); 
                    if (tmp===null) {
                        tmp ="-";
                    } 
                    $("#selectGeneSetCollection").val(tmp);
                    tmp_trimmed = tmp.replace(/\s/g, '');
					$("#selectGeneSetCollection").val(tmp_trimmed);
 					document.getElementById("extraSelectCollection").value = tmp_trimmed;
 					document.getElementById("resultCollection").value = tmp_trimmed;
              
                } else {
                    document.getElementById("radioAnalysis1").checked = true;
                    tmp = localStorage.getItem("inputTopN2");
                    if (tmp===null) {
                        tmp=10;
                    } 
                    $("#inputTopN2").val(tmp);
    			
                    tmp = localStorage.getItem("inputCorrelation2");
                    if (tmp===null) {
                        tmp=0.05;
                    } 
                    $("#inputCorrelation2").val(tmp);

                    tmp = localStorage.getItem("inputpValue2");
                    if (tmp===null) {
                        tmp=0.05;
                    }
                    $("#inputpValue2").val(tmp);

                    var form2genesetCollection = localStorage.getItem("form2genesetCollection");
                    form2geneset = localStorage.getItem("form2geneset");
                    if (form2genesetCollection !== null & form2geneset !== null) {
                        if (form2genesetCollection == "radioMSigDBH") {
                            document.getElementById("radioMSigDBH").checked = true;
                            $("#selectMSigDBH").val(form2geneset);                             
                        } else if (form2genesetCollection == "radioMSigDBC2CP") {
                            document.getElementById("radioMSigDBC2CP").checked = true;
                            $("#selectMSigDBC2CP").val(form2geneset); 
                        } else if (form2genesetCollection == "radioMSigDBC5") {
                            document.getElementById("radioMSigDBC5").checked = true;
                            $("#selectMSigDBC5").val(form2geneset); 
                        } else if (form2genesetCollection == "radioPathprint") {
                            document.getElementById("radioPathprint").checked = true;
                            $("#selectPathprint").val(form2geneset); 
                        } else if (form2genesetCollection == "radioSearchGeneSet") {
                            document.getElementById("radioSearchGeneSet").checked = true;
                            $("#textfieldGeneSet").val(form2geneset); 
                        }
                    }
    			}
                tmp = localStorage.getItem("selectClusterMethod");
                if (tmp===null) {
                    tmp="complete";
                }
                $("#selectClusterMethod").val(tmp);
                
                tmp = localStorage.getItem("checkboxHeatmap");
                if (tmp===null) {
                    tmp="true";
                }
                document.getElementById("checkboxHeatmap").checked = (tmp=="true");
                
                tmp = localStorage.getItem("checkboxNetwork");
                if (tmp===null) {
                    tmp="true";
                }
                document.getElementById("checkboxNetwork").checked = (tmp=="true");
                
                tmp = localStorage.getItem("checkboxNetworkLegend");
                if (tmp===null) {
                    tmp="true";
                }
                
                tmp = localStorage.getItem("checkboxGeneList");
                if (tmp===null) {
                    tmp="true";
                }
                document.getElementById("checkboxGeneList").checked = (tmp=="true");
                
                tmp = localStorage.getItem("checkboxCorrelationTable");
                if (tmp===null) {
                    tmp="true";
                }
                document.getElementById("checkboxCorrelationTable").checked = (tmp=="true");
			}

			// Heatmap Canvas replacement
            function makeCanvasFitBoxContainer(selector) {
                // Throw away the canvas element and make a new one.
                var selected = $(selector)[0]
                var box = $(selected).closest('.box')[0]
                var id = selected.id
                var $newCanvas = $("<canvas>")
                $newCanvas.attr('id', id)
                $(box).children('div').replaceWith($newCanvas)
                var newCanvas = $newCanvas[0]
                newCanvas.style.width = '85vh'
                newCanvas.style.height = '100%'
//                 newCanvas.style.position = 'absolute'
//                 newCanvas.style.border = '3px solid rgb(231, 231, 231)'
//                 newCanvas.style.borderRadius = '5px'
//                 newCanvas.style.cssFloat = 'left'
                newCanvas.width = box.offsetWidth - 30;
//                 console.log("fit", id, newCanvas.width)
//                 newCanvas.width = document.getElementById("cy").width;
                newCanvas.height = newCanvas.width - 10;
//                 newCanvas.width = document.getElementById("divNetwork").innerWidth;
//                 newCanvas.height = document.getElementById("divNetwork").innerHeight;

				if(document.getElementById("checkboxNetwork").checked & 
				(!document.getElementById("checkboxHeatmap").checked) &
				(!document.getElementById("checkboxGeneList").checked)
				) {newCanvas.width = Math.max(window.innerWidth-60, newCanvas.width*2+100);}
            }

			// Network Div replacement
            function makeCytoNetworkFitBoxContainer(selector) {
                // Throw away the canvas element and make a new one.
//                 var selected = $(selector)[0]
//                 var box = $(selected).closest('.box')[0]
//                 var id = selected.id
//                 var $newCyto = $("<div>")
//                 $newCyto.attr('id', id)
// 				   console.log("cytoscape networks!!!")
//                 $(box).children('div').replaceWith($newCyto)
//                 var newCyto = $newCyto[0]
//                 newCyto.style.width = '100%'
//                 newCyto.width = box.offsetWidth-30;
//                 console.log("fit", id, newCyto.width)
//                 console.log("fit", id, newCyto.height)
				if(document.getElementById("checkboxNetwork").checked & 
				(!document.getElementById("checkboxHeatmap").checked) &
// 				(!document.getElementById("checkboxNetworkLegend").checked) &
				(!document.getElementById("checkboxGeneList").checked)
				) {newCyto.width = Math.max(window.innerWidth-60, newCyto
						.width*2+100);}
            }
			
			// Re-sizing heatmap/netwrok
            function sizeCanvas() {
            	if (document.getElementById("checkboxHeatmap").checked) {
                	makeCanvasFitBoxContainer('#canvas1');
                	$("#divHeatmap").parents().show();
                	$("#divHeatmap").show();
                	$("#divHeatmap").children().show();
                }
                if (document.getElementById("checkboxNetwork").checked) {
                	makeCytoNetworkFitBoxContainer('#cy');
                	$("#netWorkHeadLabel").parents().show();
                	$("#netWorkHeadLabel").show();
                	$("#divSliders").parents().show();
                	$("#divSliders").children().show();
                }
            }

			// Get the correct geneset
			function handleAvailableGeneSetsResponse (response) {
				pathprintGeneSets = response.pathprint;
				mSigDBC2CPGeneSets = response.MSigDBC2CP;
				mSigDBC5GeneSets = response.MSigDBC5;
                mSigDBHGeneSets = response.MSigDBH;
				availableGenesets = pathprintGeneSets.concat(mSigDBC2CPGeneSets);
				availableGenesets = availableGenesets.concat(mSigDBC5GeneSets);
                availableGenesets = availableGenesets.concat(mSigDBHGeneSets);
                availableGenesets = availableGenesets.sort();
				//alert(availableGenesets.length);
				$( "#textfieldGeneSet" ).devbridgeAutocomplete({ // Need to fix the botom half disappearing!!!
					lookup: availableGenesets,
				    onSelect: function (suggestion) {geneSetSearchCompleted();}
				});
				
// 				if (originDBname == "pathprint") {originDB = pathprintGeneSets;}
// 				else if (originDBname == "MSigDBH") {originDB = mSigDBHGeneSets;}
// 				else if (originDBname == "MSigDBC2CP") {originDB = mSigDBC2CPGeneSets;}
// 				else if (originDBname == "MSigDBC5") {originDB = mSigDBC5GeneSets;}
				
				// Initial autocomplete with mSigDBC2CP
				$( "#findGeneset" ).devbridgeAutocomplete({
					lookup: availableCollection(),
					onSelect: function (suggestion) {
							$('#findGeneset').popover('show');
					},
					orientation: "top"
    			});
				
    			pathprintGeneSets = pathprintGeneSets.sort();
    			$('#selectPathprint')
         			.append($("<option></option>")
         			.attr("value","")
         			.text(""));
    			for(var i = 0; i < pathprintGeneSets.length; ++i){
					$('#selectPathprint')
         				.append($("<option></option>")
         				.attr("value",pathprintGeneSets[i])
         				.text(pathprintGeneSets[i])); 
				}
				
				mSigDBC2CPGeneSets = mSigDBC2CPGeneSets.sort();
				$('#selectMSigDBC2CP')
         			.append($("<option></option>")
         			.attr("value","")
         			.text("")); 
    			for(var i = 0; i < mSigDBC2CPGeneSets.length; ++i){
					$('#selectMSigDBC2CP')
         				.append($("<option></option>")
         				.attr("value",mSigDBC2CPGeneSets[i])
         				.text(mSigDBC2CPGeneSets[i])); 
				} 
				
				mSigDBC5GeneSets = mSigDBC5GeneSets.sort();
				$('#selectMSigDBC5')
         			.append($("<option></option>")
         			.attr("value","")
         			.text("")); 
    			for(var i = 0; i < mSigDBC5GeneSets.length; ++i){
					$('#selectMSigDBC5')
         				.append($("<option></option>")
         				.attr("value",mSigDBC5GeneSets[i])
         				.text(mSigDBC5GeneSets[i])); 
				}
                
                mSigDBHGeneSets = mSigDBHGeneSets.sort();
				$('#selectMSigDBH')
         			.append($("<option></option>")
         			.attr("value","")
         			.text("")); 
    			for(var i = 0; i < mSigDBHGeneSets.length; ++i){
					$('#selectMSigDBH')
         				.append($("<option></option>")
         				.attr("value",mSigDBHGeneSets[i])
         				.text(mSigDBHGeneSets[i])); 
				}
                checkLocalStorage();
			}
			
			getHeatmapColor = function(d, c, e) {
        		e = Number(e);
        		var a = ((e - d) * heatmapColors.length / (c - d)).toFixed() - 1;
        		return heatmapColors[Math.max(0, Math.min(heatmapColors.length - 1, a))]
    		};
			
    		// Handler for geneset choice, after "GO"
			function handleFormResponse(response) {
				$('#upgenesets').popover('hide');
				$('#downgenesets').popover('hide');
				
				// If this is called from resizing 
				
				
				
				// Empty check
				if ((document.getElementById("upgenesets").value == '')&&(document.getElementById("downgenesets").value == '')&&(document.getElementById("radioAnalysis2").checked == true)) {
					alert("Input is empty. Please select a collection and fill in your gene set/s per phenotype");
					return;
				}
				
    			if ((adjustCollection() !== 'ok') && (document.getElementById("radioAnalysis2").checked == true)) {					
    				alert(adjustCollection());
					return;
				}
    			// Setting Selected values in sliders
				document.getElementById("coefficientText").value = corrCutOffValue;
				document.getElementById("pvalueText").value = pCutOffValue;
				
				// Get unique geneset names
				if(!response) return;
				formResponse = response;
				if ((formResponse.length==0) &&(document.getElementById("radioAnalysis2").checked == true)){
					alert("Your gene set names do not match the current collection. Switching to: " + localStorage.getItem("selectGeneSetCollection"));
                    tmp = localStorage.getItem("selectGeneSetCollection"); 
                    $("#selectGeneSetCollection").val(tmp);
                    tmp_trimmed = tmp.replace(/\s/g, '');
					$("#selectGeneSetCollection").val(tmp_trimmed);
 					document.getElementById("extraSelectCollection").value = tmp_trimmed;
 					document.getElementById("resultCollection").value = tmp_trimmed;
					return;
				}
				
				var u = {}, outputGenesetNames = [];
				for(var i = 0; i < formResponse.length; ++i){
					if(!u.hasOwnProperty(formResponse[i][0])) {
						outputGenesetNames.push(formResponse[i][0]);
						u[formResponse[i][0]] = 1;
					}
					if(!u.hasOwnProperty(formResponse[i][1])) {
						outputGenesetNames.push(formResponse[i][1]);
						u[formResponse[i][1]] = 1;
					}
				}

				
				var inputGeneSetNames = [];
				inputGeneSetNames = geneSetsValue.split("\n");
				
				var alertMessage =  " empty.\n";
				var upperCaseOutputGenesetNames = [];
				for (var j = 0; j < outputGenesetNames.length; ++j){
					upperCaseOutputGenesetNames[j] = outputGenesetNames[j].toUpperCase();
				}
				
// 				This was handling empty lines before				
// 				var numberOfUnMatchedinputGenesets = 0;
// 				for ( var i = 0; i < inputGeneSetNames.length; ++i){
// 					var upperCaseInputGeneSetName = inputGeneSetNames[i].trim().toUpperCase();
// 					if (upperCaseOutputGenesetNames.indexOf(upperCaseInputGeneSetName) < 0) {
// 						alertMessage = alertMessage + inputGeneSetNames[i] + "\n"; 
// 						numberOfUnMatchedinputGenesets++;
// 					}
// 				}				
// 				if (numberOfUnMatchedinputGenesets > 0) {
// 					var do_does = "are";
// 					if (numberOfUnMatchedinputGenesets ==1) {do_does = "is";}					
// 					alertMessage = numberOfUnMatchedinputGenesets + " of your gene set names " + do_does + alertMessage;
// // 					alertMessage = alertMessage + "The database is still in development."
// // 					alertMessage = alertMessage + "\nPlease contact W.Wei@sheffield.ac.uk to help the development of the database."
// 					alert(alertMessage);
// 					return;
// 				}

				// Removing empty lines
				inputGeneSetNames = inputGeneSetNames.filter(function(entry) { return /\S/.test(entry); });
				
				displayResults ();		
		
				outputGenesetNames.sort();
				var correlationMatrix = [];
				for(var i = 0; i < outputGenesetNames.length; ++i){
					correlationMatrix[i] = [];
					for (var j = 0; j < outputGenesetNames.length; ++j){
						correlationMatrix[i][j] = 0;
					}
				}
				
				for(var k = 0; k < formResponse.length; ++k){
					var indexA, indexB;
					for (var i = 0; i < outputGenesetNames.length; ++i){
						if(formResponse[k][0] == outputGenesetNames[i]) {
							indexA = i;
						}
						if(formResponse[k][1] == outputGenesetNames[i]) {
							indexB = i;
						}
					}
					correlationMatrix[indexA][indexB] = formResponse[k][2];
					correlationMatrix[indexB][indexA] = formResponse[k][2];
					
					if(formResponse[k][2] < minCorrInHeatmap){minCorrInHeatmap = formResponse[k][2];}
					if(formResponse[k][2] > maxCorrInHeatmap){maxCorrInHeatmap = formResponse[k][2];}
					var shrinkCor = formResponse[k][2];
					var pValue = formResponse[k][3];
					if (Math.abs(shrinkCor) > maxCorrInResponse) {maxCorrInResponse = Math.abs(shrinkCor);}
					if (pValue < minPValueInResponse) {minPValueInResponse = pValue;}
					if (
							(explore && ((formResponse[k][0].toUpperCase() == form2geneset.toUpperCase()) || (formResponse[k][1].toUpperCase() == form2geneset.toUpperCase())))
							|| 
							(
								(!explore) && 
								(
									(
										$("#upgenesets").val() && 
										(
											(upGenesetNames.indexOf(formResponse[k][0].toUpperCase()) >= 0) || 
											(upGenesetNames.indexOf(formResponse[k][1].toUpperCase()) >= 0)
										)
									) ||								
									(	
										$("#downgenesets").val() && 
										(
											(downGenesetNames.indexOf(formResponse[k][0].toUpperCase()) >=0) ||
											(downGenesetNames.indexOf(formResponse[k][1].toUpperCase()) >=0)
										) 
									)
								)
							)
						)
					{
						if (Math.abs(shrinkCor) > maxCorrInResponseWithQuery) {maxCorrInResponseWithQuery = Math.abs(shrinkCor);}
						if (pValue < minPValueInResponseWithQuery) {minPValueInResponseWithQuery = pValue;}						
					}					
				}
				
                sizeCanvas();
                document.getElementById("coefficientSlider").max=maxCorrInResponseWithQuery;

// 				myColors = ['rgb(0,0,255)','rgb(7,7,255)','rgb(15,15,255)','rgb(23,23,255)','rgb(31,31,255)','rgb(39,39,255)','rgb(47,47,255)','rgb(55,55,255)','rgb(63,63,255)','rgb(71,71,255)','rgb(79,79,255)','rgb(87,87,255)','rgb(95,95,255)','rgb(103,103,255)','rgb(111,111,255)','rgb(119,119,255)','rgb(127,127,255)','rgb(135,135,255)','rgb(143,143,255)','rgb(151,151,255)','rgb(159,159,255)','rgb(167,167,255)','rgb(175,175,255)','rgb(183,183,255)','rgb(191,191,255)','rgb(199,199,255)','rgb(207,207,255)','rgb(215,215,255)','rgb(223,223,255)','rgb(231,231,255)','rgb(239,239,255)','rgb(247,247,255)',
//                				 'rgb(255,255,255)','rgb(255,247,247)','rgb(255,239,239)','rgb(255,231,231)','rgb(255,223,223)','rgb(255,215,215)','rgb(255,207,207)','rgb(255,199,199)','rgb(255,191,191)','rgb(255,183,183)','rgb(255,175,175)','rgb(255,167,167)','rgb(255,159,159)','rgb(255,151,151)','rgb(255,143,143)','rgb(255,135,135)','rgb(255,127,127)','rgb(255,119,119)','rgb(255,111,111)','rgb(255,103,103)','rgb(255,95,95)','rgb(255,87,87)','rgb(255,79,79)','rgb(255,71,71)','rgb(255,63,63)','rgb(255,55,55)','rgb(255,47,47)','rgb(255,39,39)','rgb(255,31,31)','rgb(255,23,23)','rgb(255,15,15)','rgb(255,7,7)','rgb(255,0,0)'];
				
				myColors = ['#0000ff','#0707ff','#0f0fff','#1717ff','#1f1fff','#2727ff','#2f2fff','#3737ff','#3f3fff','#4747ff','#4f4fff','#5757ff','#5f5fff','#6767ff','#6f6fff','#7777ff','#7f7fff','#8787ff','#8f8fff','#9797ff','#9f9fff','#a7a7ff','#afafff','#b7b7ff','#bfbfff','#c7c7ff','#cfcfff','#d7d7ff','#dfdfff','#e7e7ff','#efefff','#f7f7ff','#ffffff','#fff7f7','#ffefef','#ffe7e7','#ffdfdf','#ffd7d7','#ffcfcf','#ffc7c7','#ffbfbf','#ffb7b7','#ffafaf','#ffa7a7','#ff9f9f','#ff9797','#ff8f8f','#ff8787','#ff7f7f','#ff7777','#ff6f6f','#ff6767','#ff5f5f','#ff5757','#ff4f4f','#ff4747','#ff3f3f','#ff3737','#ff2f2f','#ff2727','#ff1f1f','#ff1717','#ff0f0f','#ff0707','#ff0000'];
				var cnv4=document.getElementById('canvas1');
				var ctx4=cnv4.getContext('2d');
				ctx4.clearRect(0, 0, canvas1.width, canvas1.height);
				var clusterMethod = $("#selectClusterMethod").val();
				cxHeatmap = new CanvasXpress('canvas1',
					{
						"z": { "gs" : outputGenesetNames},
						"x": { "gs" : outputGenesetNames},
						"y": { "vars": outputGenesetNames,
							   "smps": outputGenesetNames,
							   "data": correlationMatrix}
					}, 
					{
							"graphType": "Heatmap",
							"linkage" : clusterMethod,
							"varLabelRotate": 0,
							"margin" : 5,
// 							"marginBottom" : 20,
// 							"isOncoprint" : true,
							"maxSmpStringLen" : 15,
							"maxVarStringLen": 15,
							"autoScaleFont" : true,
							"varLabelFontSize" : 12,
							"smpLabelFontSize" : 12,
							"minTextSize" : 15,
							"decorationFontSize": 14,
							"disableMenu" : true,
							"disableToolbar" : true,
							"resizable" : true,
							"indicatorCenter" : "white",
							"colorSpectrum": myColors,
							"colorSpectrumZeroValue": 0,
							"legendInside": true,
							"legendPosition": "top"
					},
					{
						'click' : function(o, e, t) {
							var eventDataId = t.getEventDataId(e);
							var selctedGeneSetName = "";
							if (eventDataId[0] && eventDataId[0].match(/Smp/)) {
								var A = eventDataId[0].split("-");
                                var H = parseInt(A[1]);
								selctedGeneSetName = t.data.y.smps[H];
							} else if (eventDataId[0] && eventDataId[0].match(/Var/)) {
								var A = eventDataId[0].split("-");
                                var H = parseInt(A[1]);
								selctedGeneSetName = t.data.y.vars[H];
							} else {
							}
							document.getElementById("selctedLeafName").innerHTML = selctedGeneSetName;
							var htmlLink = "";
							if (geneSetCollectionValue.match(/MSigDB/)) {
								htmlLink = "http://www.broadinstitute.org/gsea/msigdb/cards/" + selctedGeneSetName +".html";
							} else if (geneSetCollectionValue.match(/pathprint/)) {
								htmlLink = "http://www.genomemedicine.com/content/5/7/68";
							}
							document.getElementById("selctedLeafNameLink").innerHTML = htmlLink;
							document.getElementById("selctedLeafNameLink").href = htmlLink;
							updateTable2(selctedGeneSetName);
						    $('html, body').animate({
						        scrollTop: $("#divGeneList	").offset().top
						    }, 500);
						}
					}
				);
				if (clusterMethod != "DoNotCluster") {
					cxHeatmap.clusterSamples();
					cxHeatmap.clusterVariables();
				}
				
// 				cxHeatmap.setRGB();
//         		var m = 256 / cxHeatmap.indicatorBins;
//         		var l = cxHeatmap.blues;
//         		heatmapColors = [];
//         		for (var h = 0; h < m; h++) {
//                     heatmapColors.push(l[h])
//                 }
                
//                 heatmapColors.push("rgb(255,255,255)");
//                 l = cxHeatmap.reds;
//                 for (var h = m - 1; h >= 0; h--) {
//                     heatmapColors.push(l[h])
//                 }

				heatmapColors = cxHeatmap.colorSpectrum;
				//Generating nodes and edges
				var nodes = [];
				var inNetwork ={};				
				var tableData = new Array();
				var edges = new Array();
				var edgeIndex = 0;
				for(var k = 0; k < formResponse.length; ++k){
					var shrinkCor = formResponse[k][2];
					var pValue = formResponse[k][3];
					if ( (Math.abs(shrinkCor) > corrCutOffValue) && (pValue < pCutOffValue) ) {
						tableData[edgeIndex] = formResponse[k];
						//var lineWidth = Math.abs(3*shrinkCor) + 1;
						var lineWidth = 1;
						edges[edgeIndex] = {"id1" : formResponse[k][0],
							"id2" : formResponse[k][1],
							"color" : getHeatmapColor(0-maxCorrInResponse, maxCorrInResponse, shrinkCor),
							"type" : "line",
							"width" : lineWidth,
							"value": shrinkCor};
						
						if(!inNetwork.hasOwnProperty(formResponse[k][0])) {
							inNetwork[formResponse[k][0]] = 1;
						}
						
						if(!inNetwork.hasOwnProperty(formResponse[k][1])) {
							inNetwork[formResponse[k][1]] = 1;
						}
						edgeIndex++;
					}					
				}
				
				for(var i = 0; i < outputGenesetNames.length; ++i){
					if (inNetwork.hasOwnProperty(outputGenesetNames[i])) {
                    	var newNode;
						if((explore && form2geneset.toUpperCase()==outputGenesetNames[i].toUpperCase())| ((!explore) && $("#upgenesets").val() && (upGenesetNames.indexOf(outputGenesetNames[i].toUpperCase()) >= 0)) ) {
                        	// Member of the up-regulated geneset
							newNode = {"id": outputGenesetNames[i], "color" : "rgb(102,178,255)", "shape" : "sphere"};
						} else if((!explore) && $("#downgenesets").val() && (downGenesetNames.indexOf(outputGenesetNames[i].toUpperCase()) >=0) ) {
                        	// Member of the down-regulated geneset
							newNode = {"id": outputGenesetNames[i], "color" : "rgb(25,198,126)", "shape" : "sphere"};
						}
						else {
							newNode = {"id": outputGenesetNames[i], "color" : "rgb(255, 175, 26)", "shape" : "sphere", "size": "0.5"};
						}
						nodes.push(newNode)
					}
				}
				
				$("#table1").show();
				var t = $('#table1').DataTable({
					destroy: true,
					"bAutoWidth": true,
					"columnDefs": [
						{ className: "dt-body-left dt-head-left", "targets": [ 0 ] },
						{ className: "dt-body-left dt-head-left", "targets": [ 1 ] },
						{ className: "dt-body-left dt-head-left", "targets": [ 2 ] },
						{ className: "dt-body-left dt-head-left", "targets": [ 3 ] },
						{ className: "dt-body-left dt-head-left", "targets": [ 4 ] }
					],
					"dom": 'T<"clear">lfrtip',
					buttons: [
				        'copy', 'excel', 'pdf'
				    ],
					"tableTools": {
						"sSwfPath": "swf/copy_csv_xls_pdf.swf"
					}
				});
				t.clear();
				t.rows.add( tableData );
				t.draw();
				
				
				
				
///////////////////      -----------------------------------------------------      ///////////////////
/////////////////// 	|					  START cy					      |     ///////////////////
///////////////////      -----------------------------------------------------      ///////////////////
					
					var cy = window.cy = cytoscape({
					  
						container: document.getElementById('cy'),
					  
						layout: {name: 'cose',idealEdgeLength: 50,nodeOverlap: 20},    	  
						
						style: [
							{"selector":"core","style":{"selection-box-color":"#AAD8FF","selection-box-border-color":"#8BB0D0","selection-box-opacity":"0.5"}},
							
							// Node Styles
							// 1. Adjusted size
							{"selector":"node","style":{"width":"mapData(degree,0,12,40,120)","height":"mapData(degree,0,12,40,120)","content":"data(clean_id)","font-family":"verdana","font-style":"bold",'text-wrap': 'none', "text-max-width":80,"text-outline-color":"#e6e6e6","text-outline-width":"3px","font-size":"24px","text-valign":"center","text-halign":"center","background-color":"data(color)","color":"#001933","overlay-padding":"6px","z-index":"10"}},
							// 2. Adjusted size and multiple colored nodes
							//{"selector":"node","style":{'pie-size': '0%','pie-1-background-color': 'rgb(25,198,126)','pie-1-background-size': '50%','pie-2-background-color': 'rgb(102,178,255)','pie-2-background-size': '50%',"width":"mapData(degree,0,12,40,70)","height":"mapData(degree,0,12,40,70)","content":"data(id)","font-family":"verdana","font-style":"bold","text-outline-color":"#e6e6e6","text-outline-width":"2px","font-size":"18px","text-valign":"center","text-halign":"center","background-color":"data(color)","color":"#001933","overlay-padding":"6px","z-index":"10"}},
							// 3. Fixed size
							//{"selector":"node","style":{"width":"35px","height":"35px","content":"data(id)","font-family":"verdana","font-style":"bold","text-outline-color":"#e6e6e6","text-outline-width":"2px","font-size":"16px","text-valign":"center","text-halign":"center","background-color":"data(color)","color":"#001933","overlay-padding":"6px","z-index":"10"}},

							{"selector":"node[?attr]","style":{"shape":"roundrectangle","background-color":"#aaa","text-outline-color":"#aaa","width":"20px","height":"20px","font-size":"6px","z-index":"1"}},
							{"selector":"node[?query]","style":{"background-clip":"none","background-fit":"contain"}},
							{"selector":"node:selected","style":{"border-width":"8px","border-color":"#AAD8FF","border-opacity":"0.6","background-color":"#77828C","text-outline-color":"#95a3af"}},
							{"selector":"edge","style":{"curve-style":"haystack","haystack-radius":"2","font-family":"verdana",'text-wrap': 'wrap', "text-max-width":80,"font-style":"bold","text-outline-color":"#e6e6e6","text-outline-width":"2px","opacity":"0.8","line-color":"data(color)","width":"5","overlay-padding":"3px"}},
							{"selector":"node.unhighlighted","style":{"opacity":"0.2"}},{"selector":"edge.unhighlighted","style":{"opacity":"0.05"}},
							{"selector":".highlighted","style":{"z-index":"999999"}},
							{"selector":"node.highlighted","style":{"border-width":"6px","border-color":"#AAD8FF","border-opacity":"0.5","background-color":"#394855","text-outline-color":"#394855","shadow-blur":"12px","shadow-color":"#000","shadow-opacity":"0.8","shadow-offset-x":"0px","shadow-offset-y":"4px"}},
							{"selector":"edge.filtered","style":{"opacity":"0"}}
						],
					  
						elements: [],
					      		  
						 minZoom: 0.1,
						 maxZoom: 1.3,
						 padding: 20,
						 userPanningEnabled: true, // Enables pinch/mouse wheel zoom				  
						 userPanningEnabled: true,				
						 boxSelectionEnabled: false,				  
						 selectionType: 'single', // new set of nodes every time
						 wheelSensitivity: 0.5
					
					});
								
					for (var i=0; i<nodes.length; i++) {

					    var pathway = nodes[i]
					    
					    if (pathway.color == 'rgb(25,198,126)') {clayer = 3;}
					    else if (pathway.color == 'rgb(102,178,255)') {clayer = 2;}
					    else {clayer = 1;}
					    cy.add([
					        {group: "nodes", data: {id: pathway.id, color: pathway.color, color_layer: clayer, clean_id: pathway.id.replace(/_/g , " ") }}
					    ])
					};
					
					for (var i=0; i<edges.length; i++) {

					    var link = edges[i]
					    cy.add([
					        {group: "edges", data: {id: link.id1 + ' - ' + link.id2, source: link.id1, target: link.id2, color: link.color, correlation: link.value }}
					    ])
					};
										
					// Show edge names on mouseover
					cy.on('mouseover','edge', function(event){
						  var target = event.cyTarget;
						  var target_id = target.data("id");
						  target.css({'label': target_id, "text-opacity":"1","font-size":"24px","font-style":"bold"});
						  //var x=event.cyPosition.x;
						  //var y=event.cyPosition.y; 
					});
					
					// Hide edge names on mouseout
					cy.on('mouseout','edge', function(event){
						  var target = event.cyTarget;
						  var target_id = target.data("id");
						  target.css({'label': target_id, "text-opacity":"0.0"});
					});

					cy.on('mousedown','edge', function(event){
						  var target = event.cyTarget;
						  var target_id = target.data("id");
						  var target_node = target.data("target");
						  var source_node = target.data("source");
						  target.css({"z-index":"999999"});
						  cy.nodes().css({"opacity":"0.5","z-index":"999998"});
						  cy.edges().css({"opacity":"0.3","z-index":"999997"});
						  cy.getElementById(target_node).css({'opacity': '1'});
						  cy.getElementById(source_node).css({'opacity': '1'});
						  cy.getElementById(target_id).css({'opacity': '1'});
					});
					
					cy.on('mouseup','edge', function(event){
						  var target = event.cyTarget;
						  var target_id = target.data("id");
						  var target_node = target.data("target");
						  var source_node = target.data("source");
						  target.css({"z-index":"999999"});
						  cy.nodes().css({"opacity":"1"});
						  cy.edges().css({"opacity":"1"});
					});
					
 					// Potential feature:  on taphold
				    cy.on('taphold', 'node', function(event) {
				      	var target = event.cyTarget;
				      	var full_name = target.data("id");
				      	var connected_nodes = [];
				      	var connected_edges = [];
				      	var edges = cy.edges();
					    for (var i = 0; i < edges.length; i++) {
					    	if(edges[i].data("target") == full_name){
					    		connected_nodes.push(edges[i].data("source"));
					    		connected_edges.push(edges[i].data("id")); 
					    	}
					    	if(edges[i].data("source") == full_name){
					    		connected_nodes.push(edges[i].data("target")); 
					    		connected_edges.push(edges[i].data("id")); 
					    	}
					    }
					    cy.nodes().css({"opacity":"0.2","z-index":"999998"});
					    cy.edges().css({"opacity":"0.1","z-index":"999997"});
					    cy.getElementById(full_name).css({'opacity': '1'});
					    for (var i = 0; i < connected_nodes.length; i++) {
					    	cy.getElementById(connected_nodes[i]).css({'opacity': '1'});
					    }
					    for (var i = 0; i < connected_edges.length; i++) {
					    	cy.getElementById(connected_edges[i]).css({'opacity': '1'});
					    }   
				      	target.unselect();
				    });
					
					// mouseup on taphold
					cy.on('mouseup','node', function(event){
						  var target = event.cyTarget;
						  target.css({"z-index":"999999"});
						  cy.nodes().css({"opacity":"1"});
						  cy.edges().css({"opacity":"1"});
					});
		
					// Bring up the gene set's genes and url
				    cy.on('tap', 'node', function(event) {
				      	var target = event.cyTarget;
				      	var full_name = target.data("id");
				      	updateTable2(full_name);
						document.getElementById("selctedLeafName").innerHTML = full_name;
						var htmlLink = "";
						if (geneSetCollectionValue.match(/MSigDB/)) {
							htmlLink = "http://www.broadinstitute.org/gsea/msigdb/cards/" + full_name +".html";
						} else if (geneSetCollectionValue.match(/pathprint/)) {
							htmlLink = "http://www.genomemedicine.com/content/5/7/68";
						}
						document.getElementById("selctedLeafNameLink").innerHTML = htmlLink;
						document.getElementById("selctedLeafNameLink").href = htmlLink;
				    });
					
					// Get nodes' degree and link to their size
				    var degmap = {};
				    var nodes = cy.nodes();
				    for (var i = 0; i < nodes.length; i++) {
				      degmap[nodes[i].id()] = { degree: nodes[i].degree() };
				    }
				    cy.batchData(degmap);

					// Allow two colors for specific node
// 					cy.getElementById('Complement and coagulation cascades (KEGG)').css({'pie-size': '100%'});
				    
					// Setting the active layout
 					if (activeLayout == 'circle') {circleLayout();}
 					else if (activeLayout == 'grid') {gridLayout();}
 					else if (activeLayout == 'concentric') {concentricLayout();}
 					else if (activeLayout == 'spread') {spreadLayout();}
 					else if (activeLayout == 'cola') {colaLayout();}
				
///////////////////      -----------------------------------------------------      ///////////////////
/////////////////// 	|					  END cy					      |     ///////////////////
///////////////////      -----------------------------------------------------      ///////////////////
				
				var cnv=document.getElementById('canvas3');
				var ctx = cnv.getContext('2d');
				ctx.clearRect(0, 0, canvas3.width, canvas3.height);
				ctx.font = '20px "times new roman"';
				var heightOffset = 45;
				ctx.fillStyle='black';
				ctx.fillText("Network legend", 20, 45);
				var nodeLegedRadius = 10;
				if (explore){					
					ctx.strokeStyle = "rgb(255, 175, 26)";
					ctx.fillStyle="rgb(255, 175, 26)";
					ctx.beginPath();
					ctx.arc(35, 87.5+heightOffset, nodeLegedRadius, 0, Math.PI*2, false);
					ctx.fill();
					ctx.stroke();
					ctx.strokeStyle = "rgb(102,178,255)";
					ctx.fillStyle="rgb(102,178,255)"; 
					ctx.beginPath();
					ctx.arc(35, 42.5+heightOffset, nodeLegedRadius, 0, Math.PI*2, false);
					ctx.fill();
					ctx.stroke();
					ctx.font = '20px "times new roman"';
					ctx.fillStyle='black';
					ctx.fillText("Query gene set", 60, 50+heightOffset);
					ctx.fillText("Top gene sets correlated with query", 60, 95+heightOffset);
					ctx.fillText("Correlation", 160, 135+heightOffset);
					ctx.font = '15px "times new roman"';
					ctx.fillText(0-maxCorrInResponse.toFixed(2), 10, 155+heightOffset);
					ctx.fillText(maxCorrInResponse.toFixed(2), 140, 155+heightOffset);
					ctx.fillText("0", 81, 155+heightOffset);
					ctx.lineWidth = '8';
					var d=0;
					var colorWidth = 130/heatmapColors.length;
					for (var g = 0; g < heatmapColors.length; g++) {						
						ctx.beginPath();
						ctx.strokeStyle = heatmapColors[g];
						ctx.moveTo(20+d, 130+heightOffset);
						ctx.lineTo(20+colorWidth + d, 130+heightOffset);
						ctx.stroke();
						d=d+colorWidth;
					}
				} else	if( topNValue > 0) {
					ctx.strokeStyle = "rgb(25,198,126)";
					ctx.fillStyle="rgb(25,198,126)";
					ctx.beginPath();
					ctx.arc(35, 85+heightOffset, nodeLegedRadius, 0, Math.PI*2, false);
					ctx.fill();
					ctx.stroke();
					ctx.strokeStyle = "rgb(102,178,255)";
					ctx.fillStyle="rgb(102,178,255)"; 
					ctx.beginPath();
					ctx.arc(35, 42.5+heightOffset, nodeLegedRadius, 0, Math.PI*2, false);
					ctx.fill();
					ctx.stroke();
					ctx.fillStyle='black';
					ctx.fillText("Gene sets up-regulated in phenotype 0", 60, 50+heightOffset);
					ctx.fillText("Gene sets up-regulated in phenotype 1", 60, 92.5+heightOffset);
					ctx.fillText("Top correlated gene sets", 60, 135+heightOffset);			
					ctx.fillStyle="rgb(255, 175, 26)";
					ctx.strokeStyle="rgb(255, 175, 26)";
					ctx.beginPath();	
					ctx.arc(35, 125+heightOffset, nodeLegedRadius, 0, Math.PI*2, false);
					ctx.closePath();
					ctx.fill();
					ctx.stroke();
					ctx.fillStyle='black';
					ctx.fillText("Correlation", 160, 180+heightOffset);
					ctx.font = '15px "times new roman"';
					ctx.fillText(0-maxCorrInResponse.toFixed(2), 10, 200+heightOffset);
					ctx.fillText(maxCorrInResponse.toFixed(2), 140, 200+heightOffset);
					ctx.fillText("0", 81, 200+heightOffset);
					ctx.lineWidth = '8';
					var colorWidth = 130/heatmapColors.length;
					var d=0;
					for (var g = 0; g < heatmapColors.length; g++) {						
						ctx.beginPath();
						ctx.strokeStyle = heatmapColors[g];
						ctx.moveTo(20+d, 175+heightOffset);
						ctx.lineTo(20+colorWidth + d, 175+heightOffset);
						ctx.stroke();
						d=d+colorWidth;
					}
				} else {					
					ctx.strokeStyle = "rgb(25,198,126)";
					ctx.fillStyle="rgb(25,198,126)";
					ctx.beginPath();
					ctx.arc(35, 87.5+heightOffset, nodeLegedRadius, 0, Math.PI*2, false);
					ctx.fill();
					ctx.stroke();
					ctx.strokeStyle = "rgb(102,178,255)";
					ctx.fillStyle="rgb(102,178,255)"; 
					ctx.beginPath();
					ctx.arc(35, 42.5+heightOffset, nodeLegedRadius, 0, Math.PI*2, false);
					ctx.fill();
					ctx.stroke();					
					ctx.fillStyle='black';
					ctx.fillText("Gene sets up-regulated in phenotype 0", 60, 50+heightOffset);
					ctx.fillText("Gene sets up-regulated in phenotype 1", 60, 95+heightOffset);
					ctx.fillText("Correlation", 160, 135+heightOffset);
					ctx.font = '15px "times new roman"';
					ctx.fillText(0-maxCorrInResponse.toFixed(2), 10, 155+heightOffset);
					ctx.fillText(maxCorrInResponse.toFixed(2), 140, 155+heightOffset);
					ctx.fillText("0", 81, 155+heightOffset);
					ctx.lineWidth = '8';
					//var heatmapColors= cxHeatmap.heatmapColors;
					var d=0;
					var colorWidth = 130/heatmapColors.length;
					for (var g = 0; g < heatmapColors.length; g++) {						
						ctx.beginPath();
						ctx.strokeStyle = heatmapColors[g];
						ctx.moveTo(20+d, 130+heightOffset);
						ctx.lineTo(20+colorWidth + d, 130+heightOffset);
						ctx.stroke();
						d=d+colorWidth;
					}					
				}
			}
            
            function saveSettings(){
                localStorage.setItem("explore", document.getElementById("radioAnalysis1").checked);
				localStorage.setItem("upgenesets", $("#upgenesets").val());
				localStorage.setItem("downgenesets", $("#downgenesets").val());
				localStorage.setItem("inputTopN", $("#inputTopN").val());
                localStorage.setItem("inputCorrelation", $("#inputCorrelation").val());
				localStorage.setItem("inputpValue", $("#inputpValue").val());
				localStorage.setItem("selectGeneSetCollection", $("#selectGeneSetCollection").val());				
                localStorage.setItem("selectClusterMethod", $("#selectClusterMethod").val());
				localStorage.setItem("inputTopN2", $("#inputTopN2").val());
                localStorage.setItem("inputCorrelation2", $("#inputCorrelation2").val());
				localStorage.setItem("inputpValue2", $("#inputpValue2").val());
                localStorage.setItem("form2genesetCollection", $('input:radio[name=form2geneset]:checked').val()); 
                localStorage.setItem("currentCollection", $("#currentCollection").val());
                
            }
            
			function send(){
				// Check all modules (prevent missing modu)
				document.getElementById("checkboxHeatmap").checked = true;
				document.getElementById("checkboxNetwork").checked = true;
                saveSettings();				
                var upVal = $("#upgenesets").val();
				var downVal = $("#downgenesets").val();
				var newTopNValue = $("#inputTopN").val();
				var newPCutOffValue = $("#inputpValue").val();
				var newCorrCutOffValue = $("#inputCorrelation").val();
				var newGeneSetCollectionValue = $("#selectGeneSetCollection").val();
				var newGeneSetsValue;
                $("#coefficientSlider").val()
                // Adjusting the slider
                document.getElementById("coefficientSlider").value = $("#inputCorrelation").val();
                document.getElementById("pvalueSlider").value = $("#inputpValue").val();
                // JSP API gets confused with leading and traling blank lines.
                // So eliminate those, and at the same time convert to upper case.
                upGenesetNames = upVal.trim().toUpperCase().split("\n")
                downGenesetNames = downVal.trim().toUpperCase().split("\n")
                $('#upgenesets').val(upGenesetNames.join("\n"))
                $('#downgenesets').val(downGenesetNames.join("\n"))

				if (upGenesetNames.length == 0 && downGenesetNames.length == 0)
				{
					alert("Please enter a list of gene sets!");
					return;
				}

                newGeneSetsValue = upGenesetNames.concat(downGenesetNames).join("\n").trim()

				if(((upGenesetNames.length + downGenesetNames.length)==1) && (newTopNValue==0)) {
					alert("Please specify the number of related gene sets to be found!");
					return;
				}

				if (newGeneSetsValue!=geneSetsValue |newTopNValue != topNValue | newPCutOffValue != pCutOffValue | newCorrCutOffValue != corrCutOffValue | newGeneSetCollectionValue != geneSetCollectionValue) {
					//alert("You have changed parameters!")
					geneSetsValue = newGeneSetsValue;
					topNValue = newTopNValue;					
					pCutOffValue = newPCutOffValue;
					corrCutOffValue = newCorrCutOffValue;
					geneSetCollectionValue = newGeneSetCollectionValue;
					$(".result").hide();
					//$("#divResult").find('*').hide();
					var parms = {genesets : geneSetsValue, topN : topNValue , pCutOff : pCutOffValue, corrCutOff : corrCutOffValue, geneSetCollection :geneSetCollectionValue};
					$.getJSON("getCorrelation.jsp", parms).done(handleFormResponse);
				} else {
					//alert("You have not changed parameters!")
					handleFormResponse(formResponse);
				}
			};
			
			function sendForm2(){
				// Check all modules (prevent missing module)
				document.getElementById("checkboxHeatmap").checked = true;
				document.getElementById("checkboxNetwork").checked = true;
                saveSettings();               	
				var form2genesetCollection = $('input:radio[name=form2geneset]:checked').val();
				if(form2genesetCollection =="radioPathprint") {
					form2geneset= $('#selectPathprint').val();
				} else if (form2genesetCollection == "radioMSigDBC2CP") {
					form2geneset=$('#selectMSigDBC2CP').val();
				} else if (form2genesetCollection == "radioMSigDBC5") {
					form2geneset=$('#selectMSigDBC5').val();
				} else if (form2genesetCollection == "radioMSigDBH") {
					form2geneset=$('#selectMSigDBH').val();
				} else {
					form2geneset=$('#textfieldGeneSet').val();
				}
				
                localStorage.setItem("form2geneset", form2geneset);
                
				var newGeneSetsValue = form2geneset;
                var newGeneSetCollectionValue = "";
				if(mSigDBC2CPGeneSets.indexOf(newGeneSetsValue) >=0) {
					newGeneSetCollectionValue = "MSigDBC2CP";
				}
				else if(mSigDBC5GeneSets.indexOf(newGeneSetsValue) >=0) {
					newGeneSetCollectionValue = "MSigDBC5";
				}
				else if(pathprintGeneSets.indexOf(newGeneSetsValue) >=0) {
					newGeneSetCollectionValue = "pathprint";
				}
                else if(mSigDBHGeneSets.indexOf(newGeneSetsValue) >=0) {
					newGeneSetCollectionValue = "MSigDBH";
				}
				else {
					alert("Your gene set is not in the database");
					return;
				}
				
				var newTopNValue = $("#inputTopN2").val();
				var newPCutOffValue = $("#inputpValue2").val();
				var newCorrCutOffValue = $("#inputCorrelation2").val();
				var newGeneSetsValue;
				
				// Adjusting the sliders
                document.getElementById("coefficientSlider").value = $("#inputCorrelation2").val();
                document.getElementById("pvalueSlider").value = $("#inputpValue2").val();
                
				if(newTopNValue==0) {
					alert("Please specify the number of related gene sets to be found!");
					return;
				}

				if (newGeneSetsValue!=geneSetsValue |newTopNValue != topNValue | newPCutOffValue != pCutOffValue | newCorrCutOffValue != corrCutOffValue | newGeneSetCollectionValue != geneSetCollectionValue) {
					//alert("You have changed parameters!")
					geneSetsValue = newGeneSetsValue;
					topNValue = newTopNValue;					
					pCutOffValue = newPCutOffValue;
					corrCutOffValue = newCorrCutOffValue;
					geneSetCollectionValue = newGeneSetCollectionValue;
					$(".result").hide();
					//$("#divResult").find('*').hide();
					var parms = {genesets : geneSetsValue, topN : topNValue , pCutOff : pCutOffValue, corrCutOff : corrCutOffValue, geneSetCollection :geneSetCollectionValue};
					$.getJSON("getCorrelation.jsp", parms).done(handleFormResponse);
				} else {
					//alert("You have not changed parameters!")
					handleFormResponse(formResponse);
				}
			};
			
			function updateTable2(geneSetNameValue) {
				$('#table2').hide();
				$("#table2waiting").show();
				$("#checkboxGeneList").prop('checked', true);
				//var geneSetNameValue = document.getElementById("selctedLeafName").innerHTML;
				var parms = {geneSetCollection : geneSetCollectionValue, geneSetName : geneSetNameValue};
				$.getJSON("getGeneSetMembers.jsp", parms).done(handleTable2Response);
			}
			
			function handleTable2Response(response) {
				var tableData = response;
// 				alert(tableData)
				var tableSelector = '#table2';				
				for(var k = 0; k < tableData.length; ++k){
					var entrezid = tableData[k][0];
					var htmlLink = "http://www.ncbi.nlm.nih.gov/gene/" + entrezid;
					var el = '<a target="_blank" href=' + htmlLink +">" + entrezid + "</a>";
					tableData[k][0] = el;				
				}
				var t = $(tableSelector).DataTable({
					destroy: true,
					"bAutoWidth": true,
					"columnDefs": [
						{ className: "dt-body-left dt-head-left", "targets": [ 0 ] },
						{ className: "dt-body-left dt-head-left", "targets": [ 1 ] },
						{ className: "dt-body-left dt-head-left", "targets": [ 2 ] }
					],
					"dom": 'T<"clear">lfrtip',		
					"tableTools": {
						"sSwfPath": "swf/copy_csv_xls_pdf.swf"
					}
				});
				t.clear();
				t.rows.add( tableData );
				t.draw();
				$(tableSelector).parents().show();
			 	$(tableSelector).show();
			 	$(tableSelector).children().show();
			 	$("#table2waiting").hide();
			}
			
			function doneResizing() {
				//alert("I'm done resizing for the moment");
				handleFormResponse(formResponse);
			};
			
			function hideOptionsAndResults() {
				$(".result").hide();
				$(".result").find('*').hide();
				$("#divResult").find('*').hide();
				$("#label1").hide();
				$("#inputCorrelation2").hide();
				$("#label2").hide();
				$("#inputpValue2").hide();
				$("#button4").hide();
				$("#button3").hide();
				$("#divShareButtons").hide();
			}
						
			var resizeTimer;
			$(window).resize(function() {
// 				clearTimeout(resizeTimer);
// 				resizeTimer = setTimeout(doneResizing, 100);
			});
			
			function saveHeatmapAsPNG() {cxHeatmap.print();}
			function saveNetworkAsJPG() {var jpg = cy.jpg({ full: true });downloadJpg(jpg, "graph_download.jpg");}
			function saveNetworkAsJSON() {var json = cy.elements().jsons();downloadJson(json, "graph_download.json");}

			function downloadJpg(data, filename) {
			    var pom = document.createElement('a');
			    pom.setAttribute('href', data);
			    pom.setAttribute('download', filename);

			    if (document.createEvent) {
			        var event = document.createEvent('MouseEvents');
			        event.initEvent('click', true, true);
			        pom.dispatchEvent(event);
			    }
			    else {
			        pom.click();
			    }
			}
			
			function downloadJson(data, filename) {
				var pom = document.createElement('a');
				var dataStr = JSON.stringify(data);
			    var dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
			    pom.setAttribute('href', dataUri);
			    pom.setAttribute('download', filename);
			    
			    if (document.createEvent) {
			        var event = document.createEvent('MouseEvents');
			        event.initEvent('click', true, true);
			        pom.dispatchEvent(event);
			    }
			    else {
			        pom.click();
			    }
			}
			
			// Different Network Layouts
			function gridLayout() {
				cy.nodes().css({'text-wrap': 'none', "text-max-width":80});				
				cy.layout({  
					name: 'grid',
					fit: true,
					columns: 2,
					animate: true, 
					sort: function(a, b){ return b.data('color_layer') - a.data('color_layer') } // Sort nodes by color (per row)
				});
				activeLayout = 'grid';
			}
			
			function circleLayout() {
				cy.nodes().css({'text-wrap': 'wrap', "text-max-width":80});
				cy.layout({  
					name: 'circle',
					fit: true,
					clockwise: false,
					animate: true, 
					radius: 900, 
					avoidOverlap: false, 
					sort: function(a, b){ return b.data('color_layer') - a.data('color_layer') } // Sort nodes by color
				});
				activeLayout = 'circle';
			}
			
			function colaLayout() { // Needs work
				cy.nodes().css({'text-wrap': 'none', "text-max-width":80});
				cy.layout({  
					name: 'cola', 
					fit: true,
					animate: true, 
					nodeSpacing: function( node ){ return 10; } 
				});
				activeLayout = 'cola';
			}
			
   			function concentricLayout() {
   				cy.nodes().css({'text-wrap': 'wrap', "text-max-width":80});
   				cy.layout({   					
   					name: 'concentric',
   					fit: true,
   					animate: true,
   		            concentric: function( node ){ return -(node.data('color_layer'));},
   					levelWidth: function( nodes ){ return 1;}, 
   					avoidOverlap: true,
   				}) 	
				activeLayout = 'concentric';
   			}
   			
			function coseBilkentLayout() {
				cy.nodes().css({'text-wrap': 'none', "text-max-width":80});
				cy.layout({  
					name: 'cose-bilkent', 
					fit: true,
 					numIter: 500, 
					animate: 'during', 
					gravity: 0.9,
 					nodeRepulsion: 500000, 
 					idealEdgeLength: 150
				});
				activeLayout = 'coseBilkent';
			} 
			
			function spreadLayout() {
				cy.nodes().css({'text-wrap': 'none', "text-max-width":80});
				cy.layout({ 
					name: 'random',
					minDist: 40,
					expandingFactor: 2.0,
					fit: true,
					animate: true
				});
				activeLayout = 'spread';
			}
			
			function centerLayout() {cy.center();cy.fit(cy.nodes());} 
			
			function edgewidth() {
				console.log(edgeWidth)
				if (edgeWidth == 2) {cy.edges().css({"width":"5"});edgeWidth = 5;}
				else {cy.edges().css({"width":"2"});edgeWidth = 2;}
			}
			
			function showLegend() {
				if (document.getElementById('divLegend').style.display == 'none') {
					
					document.getElementById('divLegend').style.border = '3px #e7e7e7 solid';
					document.getElementById('divLegend').style.border.radius = '5px';
					document.getElementById('divLegend').style.display = 'block';
					document.getElementById('divLegend').style.zIndex = "9999999999";
				}
				else {document.getElementById('divLegend').style.display = 'none';}
			}
			
			// Add searched gene set to phenotype 0
			function addTopheno0() {
				if (document.getElementById("upgenesets").value == "") {document.getElementById("upgenesets").value += document.getElementById("findGeneset").value;}
				else {document.getElementById("upgenesets").value += '\n' + document.getElementById("findGeneset").value;}
				$('#findGeneset').popover('hide');
			}

			// Add searched gene set to phenotype 1
			function addTopheno1() {
				if (document.getElementById("downgenesets").value == "") {document.getElementById("downgenesets").value += document.getElementById("findGeneset").value;}
				else {document.getElementById("downgenesets").value += '\n' + document.getElementById("findGeneset").value;}
				$('#findGeneset').popover('hide');
			}
			
			function exitAdd() {$('#findGeneset').popover('hide');}
			
			// Default phenotype 0 popover, visible at first visit of page. No examples offered before choosing a collection
			$(document).ready(function(){
			    $("#textArea1Info").popover({
			        title: '<span class="glyphicon glyphicon-info-sign"></span>',
// 			        content : '<p>BIOCARTA_AKAP95_PATHWAY <br> REACTOME_SIGNALING_BY_FGFR <br> ST_PAC1_RECEPTOR_PATHWAY</p><button class="button button-rounded button-tiny" style="float:right;margin-bottom:7px;" onclick="useUpExamples();">Use</button>',
			        content : '<p>Select a collection to see specific examples</p>',
			        html: true,
			        placement: "right"
			    }); 
			    $("#textArea1Info").on("show.bs.popover", function(){ $(this).data("bs.popover").tip().css("max-width", "700px"); });
			});
			
			// Default phenotype 1 popover, visible at first visit of page. No examples offered before choosing a collection
			$(document).ready(function(){
			    $("#textArea2Info").popover({
			        title: '<span class="glyphicon glyphicon-info-sign"></span>',
// 			        content : '<p>WNT_SIGNALING <br> PID_INTEGRIN5_PATHWAY <br>REACTOME_OPSINS</p><button class="button button-rounded button-tiny" style="float:right;margin-bottom:7px;" onclick="useDownExamples();">Use</button>',
			        content : 'Select a collection to see specific examples',
			        html: true,
			        placement: "right"
			        
			    }); 
			    $("#textArea2Info").on("show.bs.popover", function(){ $(this).data("bs.popover").tip().css("max-width", "700px"); });
			});
				
			// Bottom search bar popover with options to add searched gene set to either phenotype
			$(document).ready(function(){
			    $("#findGeneset").popover({
// 			        title : "<b>Hint</b>",
			    	content : '<div id="fgPop"><input class="button button-rounded button-tiny" id="add0Button" onclick="addTopheno0();" value="Add to phenotype 0" style="width:160px;padding-right:10px;padding-left:10px;"></input><input class="button button-rounded button-tiny" id="add1Button" onclick="addTopheno1();" value="Add to phenotype 1" style="width:160px;padding-right:10px;padding-left:10px;"></input><input class="button button-rounded button-tiny" id="exitButton" onclick="exitAdd();" style="width:30px;padding:2px;" value="X"></input></div>',
			    	trigger: "manual",
			    	html: true
			    }); 
			    $("#findGeneset").on("show.bs.popover", function(){ $(this).data("bs.popover").tip().css("max-width", "700px"); });
			});

			$(document).ready(function(){
		    $("#exampleButton").popover({
			        content : "Run PCxN with paper's data!!!",
			        trigger: "hover"
			    }); 
			});
				
			$(document).ready(function(){
			    $("#buttonjson").popover({
				        content : "Export to json",
				        trigger: "hover",
				        placement: "top",
				        container: "body"
				    }); 
				});

			$(document).ready(function(){
			    $("#edgesButton").popover({
				        content : "Change edges thickness",
				        trigger: "hover",
				        placement: "top",
				        container: "body"
				    }); 
				});
	
// 			// How to Explore popover
// 			$(document).ready(function(){
// 			    $("#form2").popover({
// 				        title: '<b>How to <i>Explore</i></b>',
// 				        placement: "top",
// 				        trigger: "hover",
// 				        content : "- Select geneset collection<br>- Select specific geneset (dropdown)<br>- Adjust parameters (if needed)<br>- Press <i><b>Go</b></i>",
// 				        html: true,
// 				        container: "body"
// 				    }); 
// 			    $("#form2").on("show.bs.popover", function(){ $(this).data("bs.popover").tip().css("max-width", "600px"); });
// 			});
			
// 			// How to Analyze popover
// 			$(document).ready(function(){
// 			    $("#form1").popover({
// 				        title: '<b>How to <i>Analyze</i></b>',
// 				        placement: "top",
// 				        trigger: "hover",
// 				        content : "- Select the correct geneset collection<br>- Input genesets for each phenotype <br>- Adjust parameters (if needed)<br>- Press <i><b>Go</b></i>",
// 				        html: true,
// 				        container: "body"
// 				    });
// 			   $("#form1").on("show.bs.popover", function(){ $(this).data("bs.popover").tip().css("max-width", "600px"); });
// 			});
			
			// Clustering methods info
			$(document).ready(function(){
			    $("#clusterInfo").popover({
				        title: '<b>Hierarchical clustering methods</b>',
				        placement: "top",
				        trigger: "hover",
				        content : "- In <b>complete-linkage clustering</b>, the link between two clusters contains all element pairs, and the distance between clusters equals the distance between those two elements (one in each cluster) that are farthest away from each other. The shortest of these links that remains at any step causes the fusion of the two clusters whose elements are involved.<br> - In <b>single linkage</b> (also called minimum distance) <b>clustering</b>, the clusters are grouped in a bottom-up fashion (agglomerative clustering), at each step combining two clusters that contain the closest pair of elements not yet belonging to the same cluster as each other. <br> - In <b>average linkage clustering</b>, the distance between two clusters is defined as the average distance between each point in one cluster to every point in the other cluster." ,
				        html: true,
				        container: "body"
				    });
			   $("#clusterInfo").on("show.bs.popover", function(){ $(this).data("bs.popover").tip().css("max-width", "600px"); });
			});		
			
			// Overlap Coefficient info
			$(document).ready(function(){
			    $("#CoInfo").popover({
				        title: '<b>Overlap Coefficient</b>',
				        placement: "top",
				        trigger: "hover",
				        content : "The number of common genes divided by the number of genes in the smaller gene set" ,
				        html: true,
				        container: "body"
				    });
			   $("#CoInfo").on("show.bs.popover", function(){ $(this).data("bs.popover").tip().css("max-width", "350px"); });
			});	
			
			// Handles collection related events: sync dropdown and bottom textarea, autocomplete, format examples
			$(document).ready(function(){
				var selected = $("#selectGeneSetCollection");
				selected.change(function(e) {
					localStorage.setItem("currentCollection",this.value)
					document.getElementById("extraSelectCollection").value = localStorage.getItem("currentCollection"); // "this" is the changed one
					document.getElementById("resultCollection").value  = localStorage.getItem("currentCollection"); 
// 				    originDBname = this.value;
// 					alert(originDBname);
// 				    document.getElementById("upgenesets").value = '';
// 				    document.getElementById("downgenesets").value = '';
	 				$( "#findGeneset" ).devbridgeAutocomplete({
						lookup: availableCollection(),
						onSelect: function (suggestion) {
								$('#findGeneset').popover('show');
						},
						orientation: "top"
    				});
	 				showCorrectExamplePopover();
				});
				
			});
			
			// Adjust phenotype 0,1 popovers according to current collection chosen
			function showCorrectExamplePopover() {
				$('#textArea1Info').popover('hide');
				$('#textArea2Info').popover('hide');

				if (localStorage.getItem("currentCollection") == "pathprint") {
					var up_temp_popover = $('#textArea1Info').data('bs.popover');
					up_temp_popover.options.content = '<p>ABC transporters (KEGG) <br> ACE Inhibitor Pathway (Wikipathways) <br>AR down reg. targets (Netpath)</p><button class="button button-rounded button-tiny" style="float:right;margin-bottom:7px;" onclick="useUpExamples();">Use</button>';
					up_temp_popover.options.container = "body";
					up_temp_popover.options.title = '<h5 class="custom-title"><span class="glyphicon glyphicon-info-sign"></span> Pathprint gene set example</h5>';
					var down_temp_popover = $('#textArea2Info').data('bs.popover');
					down_temp_popover.options.content = '<p>Acute myeloid leukemia (KEGG) <br> Axon guidance (Reactome) <br> Asthma (KEGG)</p><button class="button button-rounded button-tiny" style="float:right;margin-bottom:7px;" onclick="useDownExamples();">Use</button>';
					down_temp_popover.options.container = "body";
					down_temp_popover.options.title = '<h5 class="custom-title"><span class="glyphicon glyphicon-info-sign"></span> Pathprint gene set example</h5>';

				}
				
				if (localStorage.getItem("currentCollection") == "MSigDBC2CP") {
					var up_temp_popover = $('#textArea1Info').data('bs.popover');
					up_temp_popover.options.content = '<p>BIOCARTA_AKAP95_PATHWAY <br> REACTOME_SIGNALING_BY_FGFR <br> ST_PAC1_RECEPTOR_PATHWAY</p><button class="button button-rounded button-tiny" style="float:right;margin-bottom:7px;" onclick="useUpExamples();">Use</button>';
					up_temp_popover.options.container = "body";
					up_temp_popover.options.title = '<h5 class="custom-title"><span class="glyphicon glyphicon-info-sign"></span> MSigDBC2CP gene set example</h5>';
					var down_temp_popover = $('#textArea2Info').data('bs.popover');
					down_temp_popover.options.content = '<p>WNT_SIGNALING <br> PID_INTEGRIN5_PATHWAY <br>REACTOME_OPSINS</p><button class="button button-rounded button-tiny" style="float:right;margin-bottom:7px;" onclick="useDownExamples();">Use</button>';
					down_temp_popover.options.container = "body";
					down_temp_popover.options.title = '<h5 class="custom-title"><span class="glyphicon glyphicon-info-sign"></span> MSigDBC2CP gene set example</h5>';

				}		
				
				if (localStorage.getItem("currentCollection") == "MSigDBH") {
					var up_temp_popover = $('#textArea1Info').data('bs.popover');
					up_temp_popover.options.content = '<p>HALLMARK_COAGULATION <br> HALLMARK_UV_RESPONSE_UP <br>HALLMARK_WNT_BETA_CATENIN_SIGNALING</p><button class="button button-rounded button-tiny" style="float:right;margin-bottom:7px;" onclick="useUpExamples();">Use</button>';
					up_temp_popover.options.container = "body";
					up_temp_popover.options.title = '<h5 class="custom-title"><span class="glyphicon glyphicon-info-sign"></span> MSigDBH gene set example</h5>';
					var down_temp_popover = $('#textArea2Info').data('bs.popover');
					down_temp_popover.options.content = '<p>HALLMARK_UNFOLDED_PROTEIN_RESPONSE <br> HALLMARK_XENOBIOTIC_METABOLISM <br> HALLMARK_PEROXISOME</p><button class="button button-rounded button-tiny" style="float:right;margin-bottom:7px;" onclick="useDownExamples();">Use</button>';
					down_temp_popover.options.container = "body";
					down_temp_popover.options.title = '<h5 class="custom-title"><span class="glyphicon glyphicon-info-sign"></span> MSigDBH gene set example</h5>';

				}
				
				if (localStorage.getItem("currentCollection") == "MSigDBC5") {
					var up_temp_popover = $('#textArea1Info').data('bs.popover');
					up_temp_popover.options.content = '<p>REGULATION_OF_BIOLOGICAL_QUALITY <br> ACUTE_INFLAMMATORY_RESPONSE <br>ACTIN_FILAMENT_BASED_MOVEMENT</p><button class="button button-rounded button-tiny" style="float:right;margin-bottom:7px;" onclick="useUpExamples();">Use</button>';
					up_temp_popover.options.container = "body";
					up_temp_popover.options.title = '<h5 class="custom-title"><span class="glyphicon glyphicon-info-sign"></span> MSigDBC5 gene set example</h5>';
					var down_temp_popover = $('#textArea2Info').data('bs.popover');
					down_temp_popover.options.content = '<p>B_CELL_ACTIVATION <br> CELLULAR_COMPONENT_ASSEMBLY <br> CELLULAR_MACROMOLECULE_CATABOLIC_PROCESS</p><button class="button button-rounded button-tiny" style="float:right;margin-bottom:7px;" onclick="useDownExamples();">Use</button>';
					down_temp_popover.options.container = "body";
					down_temp_popover.options.title = '<h5 class="custom-title"><span class="glyphicon glyphicon-info-sign"></span> MSigDBC5 gene set example</h5>';

				}
				
				if (localStorage.getItem("currentCollection") == "-") {
					var up_temp_popover = $('#textArea1Info').data('bs.popover');
					up_temp_popover.options.content = 'Select a collection to see specific examples';
					up_temp_popover.options.container = "body";
					up_temp_popover.options.title = '<span class="glyphicon glyphicon-info-sign"></span>';
					var down_temp_popover = $('#textArea2Info').data('bs.popover');
					down_temp_popover.options.content = 'Select a collection to see specific examples';
					down_temp_popover.options.container = "body";
					down_temp_popover.options.title = '<span class="glyphicon glyphicon-info-sign"></span>';

				}
			}
			
			// Fill in phenotype 0 with appropriate gene set examples
			function useUpExamples() {
				$('#textArea1Info').popover('hide');
				if (localStorage.getItem("currentCollection") == "pathprint") {
					document.getElementById("upgenesets").value = 'ABC transporters (KEGG)' + '\n' + 'ACE Inhibitor Pathway (Wikipathways)' + '\n' + 'AR down reg. targets (Netpath)' ;
				}
				if (localStorage.getItem("currentCollection") == "MSigDBC2CP") {
					document.getElementById("upgenesets").value = 'BIOCARTA_AKAP95_PATHWAY' + '\n' + 'REACTOME_SIGNALING_BY_FGFR' + '\n' + 'ST_PAC1_RECEPTOR_PATHWAY';
				}
				if (localStorage.getItem("currentCollection") == "MSigDBH") {
					document.getElementById("upgenesets").value = 'HALLMARK_COAGULATION' + '\n' + 'HALLMARK_UV_RESPONSE_UP' + '\n' + 'HALLMARK_WNT_BETA_CATENIN_SIGNALING';
				}
				if (localStorage.getItem("currentCollection") == "MSigDBC5") {
					document.getElementById("upgenesets").value = 'REGULATION_OF_BIOLOGICAL_QUALITY' + '\n' + 'ACUTE_INFLAMMATORY_RESPONSE' + '\n' + 'ACTIN_FILAMENT_BASED_MOVEMENT';
				}

			}
			
			// Fill in phenotype 1 with appropriate gene set examples
			function useDownExamples() {
				$('#textArea2Info').popover('hide');
				if (localStorage.getItem("currentCollection") == "pathprint") {
					document.getElementById("downgenesets").value = 'Acute myeloid leukemia (KEGG)' + '\n' + 'Axon guidance (Reactome)' + '\n' + 'Asthma (KEGG)';
				}
				if (localStorage.getItem("currentCollection") == "MSigDBC2CP") {
					document.getElementById("downgenesets").value = 'WNT_SIGNALING' + '\n' + 'PID_INTEGRIN5_PATHWAY' + '\n' + 'REACTOME_OPSINS';
				}
				if (localStorage.getItem("currentCollection") == "MSigDBH") {
					document.getElementById("downgenesets").value = 'HALLMARK_UNFOLDED_PROTEIN_RESPONSE' + '\n' + 'HALLMARK_XENOBIOTIC_METABOLISM' + '\n' + 'HALLMARK_PEROXISOME';
				}
				if (localStorage.getItem("currentCollection") == "MSigDBC5") {
					document.getElementById("downgenesets").value = 'B_CELL_ACTIVATION' + '\n' + 'CELLULAR_COMPONENT_ASSEMBLY' + '\n' + 'CELLULAR_MACROMOLECULE_CATABOLIC_PROCESS';
				}

			}
			
			// Choose correct gene set collection for bottom search space autocomplete
			function availableCollection() {
				if (document.getElementById("selectGeneSetCollection").value == "pathprint") {return pathprintGeneSets;}
				else if (document.getElementById("selectGeneSetCollection").value == "MSigDBH") {return mSigDBHGeneSets;}
				else if (document.getElementById("selectGeneSetCollection").value == "MSigDBC2CP") {return mSigDBC2CPGeneSets;}
				else if (document.getElementById("selectGeneSetCollection").value == "MSigDBC5") {return mSigDBC5GeneSets;}
				else if (document.getElementById("selectGeneSetCollection").value == "-"){return availableGenesets;}
			}
			
			// Run "Run Example Analysis"
			function runExample() {
				document.getElementById("radioAnalysis2").checked = true; //verify this!
				explore = false;
				var example_Collection = $("#selectGeneSetCollection");
				example_Collection.val("MSigDBC2CP");
				document.getElementById("upgenesets").value = 'KEGG_NOTCH_SIGNALING_PATHWAY\nPID_ANGIOPOIETIN_RECEPTOR_PATHWAY\nPID_RB_1PATHWAY\nPID_PS1_PATHWAY';
				document.getElementById("downgenesets").value = 'REACTOME_A_TETRASACCHARIDE_LINKER_SEQUENCE_IS_REQUIRED_FOR_GAG_SYNTHESIS\nREACTOME_YAP1_AND_WWTR1_TAZ_STIMULATED_GENE_EXPRESSION\nKEGG_DORSO_VENTRAL_AXIS_FORMATION\nKEGG_FOCAL_ADHESION';
				document.getElementById("inputTopN").value = 5;
				document.getElementById("resultCollection").value = "MSigDBC2CP";
				
// 				document.getElementById("inputpValue").value = 0.5;
// 				document.getElementById("inputCorrelation").value = -0.5;
				send();
			}
			
			// Popover for "Run Example Analysis"
			$(document).ready(function(){
			    $("#divExample").popover({
				        title: '<b>Analysis Information</b>',
				        placement: "bottom",
				        trigger: "hover",
				        content : "<b>Collection used</b>:<br>MSigDB C5 GO BP<br><b>Phenotype 0 gene sets</b>: REACTOME_YAP1_AND_WWTR1_TAZ_STIMULATED_GENE_EXPRESSION<br>KEGG_DORSO_VENTRAL_AXIS_FORMATION<br>KEGG_FOCAL_ADHESION<br><b>Phenotype 1 gene sets</b>: REACTOME_YAP1_AND_WWTR1_TAZ_STIMULATED_GENE_EXPRESSION<br>KEGG_DORSO_VENTRAL_AXIS_FORMATION<br>KEGG_FOCAL_ADHESION<br><b>Top correlated gene sets:</b><br>5<br><b>Clustering method:</b><br>Complete Linkage",
				        html: true,
				        container: "body"
				    }); 
			    $("#divExample").on("show.bs.popover", function(){ $(this).data("bs.popover").tip().css("max-width", "600px"); });
			});
			
			// Handles analyze inputs and alerts
			function adjustCollection() {
				var pathprintGeneSetsUpperCase = pathprintGeneSets.map(function(x){ return x.toUpperCase() })
				var col = document.getElementById("selectGeneSetCollection").value;
				var upLines = document.getElementById("upgenesets").value.split('\n');
				upLines = upLines.filter(function(entry) { return /\S/.test(entry); });
				var upCols = [];  
				for(var i = 0;i < upLines.length;i++){
				    if(mSigDBC2CPGeneSets.indexOf(upLines[i]) >=0){upCols.push('MSigDBC2CP\t');}
				    else if(pathprintGeneSetsUpperCase.indexOf(upLines[i]) >=0){upCols.push('pathprint\t\t');}
				    else if(mSigDBC5GeneSets.indexOf(upLines[i]) >=0){upCols.push('MSigDBC5\t');}
				    else if(mSigDBHGeneSets.indexOf(upLines[i]) >=0){upCols.push('MSigDBH\t\t');}
				    else {upCols.push('None\t\t')}
				}
				var downLines = document.getElementById("downgenesets").value.split('\n');
				downLines = downLines.filter(function(entry) { return /\S/.test(entry); });
				var downCols = [];
				for(var j = 0;j < downLines.length;j++){
					
				    if(mSigDBC2CPGeneSets.indexOf(downLines[j]) >=0){downCols.push('MSigDBC2CP\t')}
				    else if(pathprintGeneSetsUpperCase.indexOf(downLines[j]) >=0){downCols.push('pathprint\t\t')}
				    else if(mSigDBC5GeneSets.indexOf(downLines[j]) >=0){downCols.push('MSigDBC5\t')}
				    else if(mSigDBHGeneSets.indexOf(downLines[j]) >=0){downCols.push('MSigDBH\t\t')}
				    else {downCols.push('None\t\t')}
				}
				var totalLines = upLines.concat(downLines);
				var totalCols = upCols.concat(downCols);
				var flag = false;
			    for(var i = 1; i < totalCols.length; i++){if((totalCols[i] !== totalCols[0]) || (totalCols[i] == 'None\t\t') || (totalCols[0] == 'None\t\t')){flag = true;}}
				var c2_count = countInArray(totalCols, 'MSigDBC2CP\t');
				var c5_count = countInArray(totalCols, 'MSigDBC5\t');
				var path_count = countInArray(totalCols, 'pathprint\t\t');
				var h_count = countInArray(totalCols, 'MSigDBH\t\t');
			    // Incorrect input cases
			    if (flag){
			    	
					if ((c2_count > c5_count)&&(c2_count > path_count)&&(c2_count > h_count)) {
						var tmp = 'Incorrect gene set input, the following do not belong to majority collection: MSigDBC2CP\n\nPhenotype 0\n-----------------\n';
						for (var i = 0;i < upLines.length;i++) {
							if(upCols[i] !== 'MSigDBC2CP\t'){tmp += upCols[i] + '->  ' + upLines[i] + '\n';}
						}
						tmp += '\nPhenotype 1\n-----------------\n';
						for (var i = 0;i < downLines.length;i++) {
							if(downCols[i] !== 'MSigDBC2CP\t'){tmp += downCols[i] + '->  ' + downLines[i] + '\n';}
						}
						return tmp;
					}
					else if ((c5_count > c2_count)&&(c5_count > path_count)&&(c5_count > h_count)) {
						var tmp = 'Incorrect gene set input, the following do not belong to majority collection: MSigDBC5\n\nPhenotype 0\n-----------------\n';
						for (var i = 0;i < upLines.length;i++) {
							if(upCols[i] !== 'MSigDBC5\t'){tmp += upCols[i] + '->  ' + upLines[i] + '\n';}
						}
						tmp += '\nPhenotype 1\n-----------------\n';
						for (var i = 0;i < downLines.length;i++) {
							if(downCols[i] !== 'MSigDBC5\t'){tmp += downCols[i] + '->  ' + downLines[i] + '\n';}
						}
						return tmp;
					}
					else if ((path_count > c5_count)&&(path_count > c2_count)&&(path_count > h_count)) {
						var tmp = 'Incorrect gene set input, the following do not belong to majority collection: pathprint\n\nPhenotype 0\n-----------------\n';
						for (var i = 0;i < upLines.length;i++) {
							if(upCols[i] !== 'pathprint\t\t'){tmp += upCols[i] + '->  ' + upLines[i] + '\n';}
						}
						tmp += '\nPhenotype 1\n-----------------\n';
						for (var i = 0;i < downLines.length;i++) {
							if(downCols[i] !== 'pathprint\t\t'){tmp += downCols[i] + '->  ' + downLines[i] + '\n';}
						}
						return tmp;
					}
					else if ((h_count > c5_count)&&(h_count > c2_count)&&(h_count > path_count)) {
						var tmp = 'Incorrect gene set input, the following do not belong to majority collection: MSigDBH\n\nPhenotype 0\n-----------------\n';
						for (var i = 0;i < upLines.length;i++) {
							if(upCols[i] !== 'MSigDBH\t\t'){tmp += upCols[i] + '->  ' + upLines[i] + '\n';}
						}
						tmp += '\nPhenotype 1\n-----------------\n';
						for (var i = 0;i < downLines.length;i++) {
							if(downCols[i] !== 'MSigDBH\t\t'){tmp += downCols[i] + '->  ' + downLines[i] + '\n';}
						}
						return tmp;
					}
					else {
						var tmp = 'Incorrect gene set input, please choose one collection.\n\nPhenotype 0\n-----------------\n';
						for (var i = 0;i < upLines.length;i++) {
							tmp += upCols[i] + '->  ' + upLines[i] + '\n';
						}
						tmp += '\nPhenotype 1\n-----------------\n';
						for (var i = 0;i < downLines.length;i++) {
							tmp += downCols[i] + '->  ' + downLines[i] + '\n';
						}
						return tmp;
					}
				}
				// Correct input case
			    else{
					if(col !== totalCols[0]) {localStorage.setItem("selectGeneSetCollection",totalCols[0]);}	
					return 'ok';
				}
			}	
			
			// Counts occurences in array
			function countInArray(array, what) {
			    var count = 0;
			    for (var i = 0; i < array.length; i++) {
			        if (array[i] === what) {
			            count++;
			        }
			    }
			    return count;
			}
		
			// Select dynamically from dropdown
			function selectItemByValue(elmnt, value){
				
				for(var i=0; i < elmnt.options.length; i++)
				{
					if(elmnt.options[i].value == value)
				        elmnt.selectedIndex = i; 
				}
			}
	
			// Scrolls window
			function scrollWin(x) {
				document.getElementById(x).scrollIntoView({ 
					  behavior: 'smooth' 
				});
			
		}
		</script>
</head>
<body>
	<div class="container-fluid">
		<div class="row" id="divHeader">
			<div class="col-sm-12">
				<div class="col-sm-24 row" id="menu" style="float: right;position:static;margin: 5px;"">
					<ul>
						<li class="first"><a href="index.html" accesskey="1" title="">Home</a></li>
						<li><a href="news.html" accesskey="2" title="">News</a></li>
						<li><a href="about.html" accesskey="3" title="">About</a></li>						
						<li><a href="video.html" accesskey="4" title="">Video Tutorial</a></li>
						<li><a href="citeUs.html" accesskey="5" title="">Cite us</a></li>
						<li><a href="contacts.html" accesskey="6" title="">Contacts</a></li>			
					</ul>
				</div>
				<div class="col-sm-24 row" style="margin-bottom: 11.4333px;float: inherit;width: 100%;">
					<h1><span style="font-size: 1em;"><a href="index.html"><img src="journal125.png" width="10%" height="10%" style="padding-right: 9px; vertical-align: bottom"></a>PCxN&nbsp</span><span style="font-size: 0.8em;">The Pathway Co-Activity Map</span></h1>
				</div>

			</div>
		</div>
		<div class="row" id="divInput">
			<div class="col-sm-6">
				<form id="form2" name="form2" class="well"  style="width:80%;font-size:1m;min-width:513px">
					<label for="inputTopN2" id="findLabel2" style="margin-bottom: 26px;margin-top: 30px"><font color="#e67300">Step 1:</font> Find top</label> <input type="text" id="inputTopN2" value="10" style="border-radius:2px;width:15%"/>
					<label> gene sets</label><br>
					<label><font color="#e67300">Step 2:</font> Correlated with</label><br>
					<input type="radio" id="radioMSigDBH" name="form2geneset" value="radioMSigDBH" style="border-radius:2px;" checked>Select a gene set from MSigDB H (Hallmark gene sets) <br><select id="selectMSigDBH" size="1" style="margin-bottom:5px;width:100%"></select><br>
					<input type="radio" id="radioMSigDBC2CP" name="form2geneset" value="radioMSigDBC2CP" style="border-radius:2px;" checked>Select a gene set from MSigDB C2 CP (Canonical pathways) <br><select id="selectMSigDBC2CP" size="1" style="margin-bottom:5px;width:100%"></select><br>
					<input type="radio" id="radioMSigDBC5" name="form2geneset" value="radioMSigDBC5" style="border-radius:2px;">Select a gene set from MSigDB C5 GO BP gene sets <br><select id="selectMSigDBC5" size="1" style="margin-bottom:5px;width:100%"></select><br>
					<input type="radio" id="radioPathprint" name="form2geneset" value="radioPathprint" style="border-radius:2px;">Select a gene set from Pathprint <br> <select id="selectPathprint" size="1" style="margin-bottom:5px;width:100%"></select><br> 
					<input type="radio" id="radioSearchGeneSet" name="form2geneset" value="radioSearchGeneSet">Search a gene set <input id="textfieldGeneSet" style="border-radius:2px;margin-bottom: 20px;width:100%"><br>
<!-- 					<input type="radio" id="radioSearchGeneSet" name="form2geneset" value="radioSearchGeneSet">Search a gene set <input id="textfieldGeneSet" onkeypress="hideOptionsAndResults()"  style="border-radius:2px;margin-bottom: 20px;"><br> -->
					<label id="ste3label"><font color="#e67300">Step 3:</font> </label><br>
					<label id="label1" for="inputCorrelation2" style="margin-bottom: 12px;">Absolute correlation coefficient greater than </label><input type="text" id="inputCorrelation2" value="0.05" style="border-radius:2px;margin-left:2px;width:15%"/><br>
					<label id="label2" for="inputpValue2" style="margin-bottom: 13px;">and p-value less than</label><input type="text" id="inputpValue2" value="0.05" style="border-radius:2px;margin-left:2px;width:15%"/><input type="button" class="button-tiny button-rounded button-raised button-action" id="button3" value=" GO "	onclick="javascript:sendForm2();" style="float:right;margin-right:9px;height:25px;padding-left:5px;padding-right:5px;margin-top:45px;" /> <input  class="button-tiny button-rounded button-raised button-caution"type="reset" id="button4" value=" Reset " style="float:right;height:25px;padding-left:5px;padding-right:5px;margin-top:45px;" /> 
				</form>
				<form id="form1" name="form1" class="well"  style="width:80%;font-size:1m;min-width:513px"> 
					<label for="selectGeneSetCollection" style="margin-bottom: 13px;"><font color="#e67300">Step 1:</font>   Select gene set collection: </label>
					<select id="selectGeneSetCollection" size="1" style="height: 25px;border-radius:2px;width:49.5%">
						<option value="-" >-</option>
						<option value="MSigDBC2CP">MSigDB C2 CP (Canonical pathways)</option>
						<option value="pathprint">Pathprint</option>
						<option value="MSigDBH">MSigDB H (Hallmark gene sets)</option>
						<option value="MSigDBC5">MSigDB C5 GO BP gene sets</option>
					</select><br>
					<label for="upgenesets" style="display: inline;"><font color="#e67300">Step 2:</font> Find correlation among gene sets up-regulated in phenotype 0 </label><br>
					<textarea rows="7" cols="50" id="upgenesets" data-toggle="popover" style="width:98%;border-radius:2px;"></textarea><i class="fa fa-info-circle" aria-hidden="true" id="textArea1Info" style="padding-left: 5px;cursor: pointer;display: inline;float:right;position:absolute;padding-top:5px;"></i><br> 
					<label for="downgenesets" style="">and gene sets	up-regulated in phenotype 1 (optional) </label><br>
					<textarea rows="7" cols="50" id="downgenesets" data-toggle="popover" style="width:98%;margin-bottom: 5px;border-radius:2px;"></textarea><i class="fa fa-info-circle" fa-2x aria-hidden="true" id="textArea2Info" style="padding-left: 5px;cursor: pointer;display: inline;float:right;position:absolute;padding-top:5px;"></i><br>
					<label for="inputTopN" style="margin-bottom: 13px;"><font color="#e67300">Step 3:</font> Top</label> <input type="text" id="inputTopN" value="0" style="border-radius:2px;" />
					<label>correlated genes sets</label><br>
					<label for="inputCorrelation" style="margin-bottom: 13px;border-radius:2px;"> with absolute correlation coefficient greater than</label>
					<input type="text" id="inputCorrelation" value="0.05" style="width:25%;border-radius:2px;"/><br>
					<label for="inputpValue" style="margin-bottom: 13px;border-radius:2px;">and p-value less than</label>
					<input type="text" id="inputpValue" value="0.05" style="border-radius:2px;"/><br>

					<label for="selectClusterMethod">Cluster gene sets using</label> <select id="selectClusterMethod" size="1" style="height: 25px;">
						<option value="average">Average linkage</option>
						<option value="complete" selected="selected">Complete linkage</option>
						<option value="single">Single linkage</option>
						<option value="DoNotCluster">Do not cluster</option>
					</select>
					<i class="fa fa-info-circle" fa-2x aria-hidden="true" id="clusterInfo"></i>
					<input type="button" class="button-tiny button-rounded button-raised button-action" id="button1" value=" GO " onclick="javascript:send();" style="float:right;margin-right:9px;height:25px;padding-left:5px;padding-right:5px"/><input type="reset" class="button-tiny button-rounded button-raised button-caution" id="button2" value=" Reset " style="float:right;height:25px;padding-left:5px;padding-right:5px; "/> 
				</form>
							
				<form class="form-inline" id="extraOptions" style="width: 80%;float: right;position: relative;min-width:513px">
					<input id="findGeneset" placeholder="&#xF002    Search geneset name and add it to a phenotype" class="well col-sm-7" style ="width:70%;float:right;border-top-left-radius: 0px;border-bottom-left-radius: 0px;font-family: FontAwesome;font-style: normal;font-weight: normal;text-decoration: inherit;"  data-toggle="popover" data-placement="bottom" title =""></input>		
					<input id="extraSelectCollection" class="well" value="-" style="height:60px;float:left;background: #EEE;border-top-right-radius: 0px;border-bottom-right-radius: 0px;text-align:center;width:30%;"  disabled></input>	
				</form>				
			</div>
			<div class="col-sm-6" style="height:550px">
				<input class="col-sm-12 well button button-glow" type="button" value="&#xf04b Run Example Analysis" onclick="runExample();" style="font-family: FontAwesome;border-radius:4px;min-height:131px;height:24%;font-size: x-large;margin-bottom: 13px;width:80%;min-width:513px" id="divExample";></input>
				<div class="col-sm-12 well" style="border-radius: 4px;margin-bottom: 12px;width:80%;min-width:513px;height:34%;" id="divAnalysis1">
					<h4>
						<input type="radio" id="radioAnalysis1" name="radioAnalysis"
							value="radioAnalysis1" checked><label for="radioAnalysis1"> Explore</label>
					</h4>
					<p>
						Select a single pathway/gene set from one of the four collections
						( <a target="_blank"
							href="http://www.broadinstitute.org/gsea/msigdb/index.jsp">MSigDB</a>
						H hallmark gene sets, <a target="_blank"
							href="http://www.broadinstitute.org/gsea/msigdb/index.jsp">MSigDB</a>
						C2 Canonical pathways, <a target="_blank"
							href="http://www.broadinstitute.org/gsea/msigdb/index.jsp">MSigDB</a>
						C5 GO BP gene sets, and <a target="_blank"
							href="http://www.genomemedicine.com/content/5/7/68">Pathprint</a>
						) and discover its correlated pathway/gene sets within the same
						collection.
					</p>
				</div>
<!-- 				<div class="col-sm-12"><br></div> -->
				<div class="col-sm-12 well" style="border-radius: 4px;margin-bottom: 12px;width:80%;min-width:513px;height:34%" id="divAnalysis2">
					<h4>
						<input type="radio" id="radioAnalysis2" name="radioAnalysis"
							value="radioAnalysis2"><label for="radioAnalysis2"> Analyze</label>
					</h4>
					<p>
						Discover correlation relationships among multiple pathways/gene
						sets identified by <a target="_blank"
							href="http://www.broadinstitute.org/gsea/index.jsp">GSEA</a>
						(gene set enrichment analysis). All the input pathways/gene sets
						should come from the same collection. <a target="_blank"
							href="http://www.broadinstitute.org/gsea/msigdb/index.jsp">MSigDB</a>
						H hallmark gene sets, <a target="_blank"
							href="http://www.broadinstitute.org/gsea/msigdb/index.jsp">MSigDB</a>
						C2 Canonical pathways, <a target="_blank"
							href="http://www.broadinstitute.org/gsea/msigdb/index.jsp">MSigDB</a>
						C5 GO BP gene sets, and <a target="_blank"
							href="http://www.genomemedicine.com/content/5/7/68">Pathprint</a>
						are treated as four separate collections.
					</p>
				</div>
<!-- 				<div class="col-sm-12"><br></div> -->
			</div>
		</div>
		<div class="row" id="divShareButtons" style="position:fixed;bottom:0px;width:100%;padding-top:20px;">
			<label>Share PCxN</label> <a class="sbg-button sbg-button-facebook fa-2x"
				data-sbg-network="facebook" data-sbg-url="http://pcxn.org:8080"
				data-sbg-title="PCxN The Pathway Co-Activity Map"
				data-sbg-summary="A database of correlation between pathways/gene sets."
				data-sbg-image="http://pcxn.org:8080/pcxnscreenshot1.png"
				data-sbg-width="600" data-sbg-height="368"> <i
				class="sbg-button-icon fa fa-facebook"></i>
			</a> <a class="sbg-button sbg-button-twitter fa-2x" data-sbg-network="twitter"
				data-sbg-text="http://pcxn.org A database of correlation between pathways and gene sets."
				data-sbg-via="" data-sbg-hashtags="pathway,geneset"
				data-sbg-width="600" data-sbg-height="258"> <i
				class="sbg-button-icon fa fa-twitter"></i>
			</a> <a class="sbg-button sbg-button-linkedin fa-2x"
				data-sbg-network="linkedin" data-sbg-url="http://pcxn.org:8080"
				data-sbg-title="PCxN The Pathway Co-Activity Map" data-sbg-source=""
				data-sbg-summary="A database of correlation between pathways/gene sets."
				data-sbg-width="585" data-sbg-height="471"> <i
				class="sbg-button-icon fa fa-linkedin"></i>
			</a> <a class="sbg-button sbg-button-google-plus fa-2x"
				data-sbg-network="google-plus" data-sbg-url="http://pcxn.org:8080"
				data-sbg-width="500" data-sbg-height="505"> <i
				class="sbg-button-icon fa fa-google-plus"></i>
			</a> <a class="sbg-button sbg-button-pinterest fa-2x"
				data-sbg-network="pinterest" data-sbg-url="http://pcxn.org"
				data-sbg-media="http://pcxn.org/pcxnscreenshot1.png"
				data-sbg-description="A database of correlation between pathways/gene sets."
				data-sbg-width="750" data-sbg-height="322"> <i
				class="sbg-button-icon fa fa-pinterest"></i>
			</a> <a class="sbg-button sbg-button-email fa-2x" data-sbg-network="email"
				data-sbg-subject="PCxN The Pathway Co-Activity Map"
				data-sbg-body="A database of correlation between pathways/gene sets, http://pcxn.org">
				<i class="sbg-button-icon fa fa-envelope"></i>
			</a>
			<script>
					sbg();
				</script>
		</div>
		<div class="row" id="divResult">
			<div class="row result"
				style="margin-top: 12px; margin-bottom: 12px;">
				<div class="col-sm-12 result" style="text-align: center;border: 1px solid black;padding-right: 12px;padding-left: 12px;min-width:664px;">

					<div class="col-sm-12 result" id="menu2"
						style=" background: rgba(226,226,226,1);
								background: -moz-linear-gradient(top, rgba(226,226,226,1) 0%, rgba(219,219,219,1) 0%, rgba(254,254,254,1) 51%, rgba(209,209,209,1) 100%);
								background: -webkit-gradient(left top, left bottom, color-stop(0%, rgba(226,226,226,1)), color-stop(0%, rgba(219,219,219,1)), color-stop(51%, rgba(254,254,254,1)), color-stop(100%, rgba(209,209,209,1)));
								background: -webkit-linear-gradient(top, rgba(226,226,226,1) 0%, rgba(219,219,219,1) 0%, rgba(254,254,254,1) 51%, rgba(209,209,209,1) 100%);
								background: -o-linear-gradient(top, rgba(226,226,226,1) 0%, rgba(219,219,219,1) 0%, rgba(254,254,254,1) 51%, rgba(209,209,209,1) 100%);
								background: -ms-linear-gradient(top, rgba(226,226,226,1) 0%, rgba(219,219,219,1) 0%, rgba(254,254,254,1) 51%, rgba(209,209,209,1) 100%);
								background: linear-gradient(to bottom, rgba(226,226,226,1) 0%, rgba(219,219,219,1) 0%, rgba(254,254,254,1) 51%, rgba(209,209,209,1) 100%);
								filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#e2e2e2', endColorstr='#d1d1d1', GradientType=0 );
 								border: 1px solid #ffffff;
/* 								border-radius: 25px;  */
								padding-top: 5px;">
						<label class="result"
							style="display: inline-block; position: relative;">Show</label> <input
							class="result" type="checkbox" id="checkboxHeatmap"
							checked="checked"
							style="display: inline-block; position: relative; vertical-align: middle; margin-top: -2px; margin-left: 5px;">
						<label for="checkboxHeatmap">Heatmap</label> <input class="result" type="checkbox" id="checkboxNetwork"
							checked="checked"
							style="display: inline-block; position: relative; vertical-align: middle; margin-top: -2px; margin-left: 5px;">
						<label for="checkboxNetwork">Network</label>
						<!-- 							<input class="result" type="checkbox" id="checkboxNetworkLegend" style="display:inline-block; position:relative;vertical-align:middle; margin-top: -2px;margin-left: 5px;"> network legend -->
						<input class="result" type="checkbox" id="checkboxGeneList"
							style="display: inline-block; position: relative; vertical-align: middle; margin-top: -2px; margin-left: 5px;">
						<label for="checkboxGeneList">Gene list</label> <input class="result" type="checkbox"
							id="checkboxCorrelationTable"
							style="display: inline-block; position: relative; vertical-align: middle; margin-top: -2px; margin-left: 5px;">
						<label for="checkboxCorrelationTable">Network data table</label>
						<input id="resultCollection" style="float:right;width:100px;text-align:center;background: transparent;border: 0;" value="-" disabled></input>
						<label for="resultCollection" style="float:right;">Collection:</label>						
					</div>
					
				</div>
			</div>
			<div class="row result" id="upperLevel">
				<div class="col-sm-12">
					<div class="col-sm-6 result box" id="divHeatmap" style="overflow-x: auto;overflow-y: hidden;">
						<!-- The "box" class here is used to find the right DIV when resizing.
                         	See sizeCanvas() -->
						<label style="display: block; text-align: center; font-size: 20px;padding-bottom: 10px;">Correlation Heatmap</label>
						<button class="button-tiny button button-rounded button-raised button-small-caps" type="button" id="buttonpng1" onclick="saveHeatmapAsPNG();" style="padding-right: 11px; padding-left: 11px;margin-bottom: 5px;margin-top: 5px;position: absolute; font-size:14px;" />PNG</button>
						<!-- This div gets replaced by sizeCanvas() -->
						<div>
							<canvas id="canvas1" responsive="true"></canvas>
						</div>
					</div>
					<div class="col-sm-6 result row" id="divNetwork" style="left: 15px; padding-right: 0px; margin-right: 0px;">
						<label class="result" id="netWorkHeadLabel"	style="display: block; text-align: center; font-size: 20px;">Correlation Network</label>
						<div class="col-sm-12 row result box"
							style="padding-left: 15px; padding-top: 10px;">
							<div class="result row" style="position: relative">
								<div class="button-group" style="position: absolute; z-index: 99999999; width:100%; background-color: #e7e7e7;padding-top: 3.5px; padding-bottom: 2.5px;border-radius:5px; border-bottom-right-radius: 0px;border-bottom-left-radius: 0px;">
<!-- 									<label style=" padding-left: 24px; float:left; padding-top: 2.5px;color: #575757;" />Tools</label> -->
									<div id="miscButtonGroup" class="btn-group" style="float:right; margin-right: 5px; font-size:14px;">
										<button class="button-tiny button button-rounded button-raised button-small-caps" type="button" onclick="centerLayout();" style="padding-right: 10px;padding-left: 10px;"/>Center Graph</button>
										<button id="edgesButton"  class="button-tiny button button-rounded button-raised button-small-caps" type="button" onclick="edgewidth();" style="padding-right: 10px;padding-left: 10px;"/>Edges</button>
									</div>
									<div id="layoutButtonGroup" class="btn-group" style="float:right; margin-right: 5px;font-size:14px;">
										<button class="button-tiny button button-rounded button-raised button-small-caps" type="button"  onclick="spreadLayout();" style="padding-right: 10px;padding-left: 10px;"/>Spread</button>
										<button class="button-tiny button button-rounded button-raised button-small-caps" type="button"  onclick="gridLayout();" style="padding-right: 10px;padding-left: 10px;"/>Grid</button>
										<button class="button-tiny button button-rounded button-raised button-small-caps" type="button"  onclick="circleLayout();" style="padding-right: 10px;padding-left: 10px;"/>Circle</button>
										<button class="button-tiny button button-rounded button-raised button-small-caps" type="button"  onclick="colaLayout();" style="padding-right: 10px;padding-left: 10px;"/>Physics</button>
										<button class="button-tiny button button-rounded button-raised button-small-caps" type="button"  onclick="concentricLayout();" style="padding-right: 10px;padding-left: 10px;"/>Concentric</button>
									</div>
									<div id="saveButtonGroup" class="btn-group" style="float:left; margin-left: 5px; margin-left: 5px;font-size:14px;">
										<button class="button-tiny button button-rounded button-raised button-small-caps" type="button" id="buttonjpg" onclick="saveNetworkAsJPG();" style="padding-right: 10px; padding-left: 10px;" />JPG</button>
										<button class="button-tiny button button-rounded button-raised button-small-caps" type="button" id="buttonjson" onclick="saveNetworkAsJSON();" style="padding-right: 10px; padding-left: 10px;" />Cytoscape</button>
									</div>
								</div>
										
								<div class="result" id="cy"></div>
								<div id="divLegend" style="display:none;position:absolute;margin-top:32px;border-radius:5px;border-top-right-radius: 0px;border-top-left-radius: 0px;background:#f7f7f7;bottom: 0;right: 0;"><canvas id="canvas3" width="450" height="250"></canvas></div>
							</div>
						</div>
						<div class="col-sm-12 result row" id="divSliders"
							style="padding-top: 13px;padding-bottom: 14px; padding-right: 0px; background-color: #e7e7e7;border-bottom-right-radius: 5px;border-bottom-left-radius: 5px; padding-left: 5px;">
							<div class="col-sm-12 box result" style="padding-left: 15px; width: 75%;">
								<div class="col-sm-12 row result">
									<label class="result" for="amount" style="width: 180px">Min	absolute correlation:</label>
									<input class="result" size="3" type="range" id="coefficientSlider" min="0.01" max="1" step="0.01" style="width: 150px; display: inline" />
									<input class="result" disabled=true size="3" type="text" id="coefficientText" style="border: 0; margin-bottom: 0; width: 50px; background-color:#f6f6f6 " />
								</div>
								<div class="col-sm-12 row result">
									<label class="result" for="pvalueSlider" style="width: 180px">Max correlation p value:</label>
									<input class="result" size="3" type="range" id="pvalueSlider" min="0.001" max="0.05" step="0.001" style="width: 150px; display: inline" />
									<input class="result" disabled=true size="3" type="text" id="pvalueText" style="border: 0; margin-bottom: 0; width: 50px; background-color:#f6f6f6" />
								</div>
							</div>							
							<button type="button" class="btn btn-lg col-sm-3 row result user" onclick="showLegend();" style="background-color:#f6f6f6;margin-top: 9px;" >Legend</button>
						</div>
					</div>
				</div>
			</div>
			<div class="row result" id="divGeneList" style="padding: 20px; padding-top: 15px; margin-top: 30px; border-top: 5px solid #d3d3d3; margin-left: 0px; margin-right: 0px;">
				<label class="result" style="font-size: 24px; margin-bottom: 15px;">Gene set (click on a gene set name on heatmap or network to select)</label><br>
				<label class="result">Name</label><br>
				<p class="result" id="selctedLeafName"></p>
				<label>External links</label><br> <a id="selctedLeafNameLink" target="_blank" href=""></a> <br>
				<label>Members</label><br>
				<table id="table2" class="display" cellspacing="0" width="100%">
					<thead>
						<tr>
							<th>NCBI GeneID</th>
							<th>Symbol</th>
							<th>Description</th>
						</tr>
					</thead>

					<tfoot>
						<tr>
							<th>NCBI GeneID</th>
							<th>Symbol</th>
							<th>Description</th>
						</tr>
					</tfoot>
				</table>
				<p id="table2waiting" class="waitmessage">Please wait. Getting data ....</p>
			</div>
			<div class="row result" id="divTable1"
				style="border-top: 5px solid #d3d3d3;">
				<div class="col-sm-12 result">
					<div class="col-sm-12 result">
						<h3 class="result" style="font-weight: bold; margin-bottom: 15px">Network Data Table</h3>
						<div class="col-sm-12 result">
						
							<table id="table1" class="display result" cellspacing="0" width="100%">
								<thead class="result">
									<tr class="result">
										<th class="result">Gene Set A</th>
										<th class="result">Gene Set B</th>
										<th class="result">Correlation</th>
										<th class="result">p Value</th>
										<th class="result">Overlap Coefficient<i class="fa fa-info-circle" aria-hidden="true" id="CoInfo" style="cursor: pointer;padding-left: 20px;z-index:9999;"></i></th>
										
									</tr>
								</thead>
								
								<tfoot class="result">
									<tr class="result">
										<th class="result">Gene Set A</th>
										<th class="result">Gene Set B</th>
										<th class="result">Correlation</th>
										<th class="result">p Value</th>
										<th class="result">Overlap Coefficient</th>
									</tr>
								</tfoot>
								
							</table>
							
						</div>
					</div>
				</div>
			</div>
			
		</div>
		<div id="navMenu" class="navigation_arrows">
		  	  <button onClick ="scrollWin('upperLevel')" class="button button-block button-small button-rounded button-border" style="padding-left:10px;padding-right:10px;background:white;"><i class="fa fa-arrow-circle-o-right" aria-hidden="true"></i> Heatmap/Network</button>
	  		  <button onClick ="scrollWin('divGeneList')" class="button button-block button-small button-rounded button-border" style="padding-left:25px;padding-right:25px;background:white;"><i class="fa fa-arrow-circle-o-right" aria-hidden="true"></i> Gene set list</button>
	  		  <button onClick ="scrollWin('divTable1')" class="button button-block button-small button-rounded button-border"style="padding-left:7px;padding-right:7px;background:white;"><i class="fa fa-arrow-circle-o-right" aria-hidden="true"></i> Network data Table</button>
		</div>
	</div>
	<br>
	<script>
		
		function changeRadioSelection (e){
			if(e.target.id =="selectPathprint") {document.getElementById("radioPathprint").checked = true;
			} else if(e.target.id =="selectMSigDBC2CP") {document.getElementById("radioMSigDBC2CP").checked = true;
			} else if(e.target.id =="selectMSigDBC5") {document.getElementById("radioMSigDBC5").checked = true;
			} else if(e.target.id =="selectMSigDBH") {document.getElementById("radioMSigDBH").checked = true;
			} else {}
			$("#label1").show();
			$("#inputCorrelation2").show();
			$("#label2").show();
			$("#inputpValue2").show();
			$("#button4").show();
			$("#button3").show();
		}
		function geneSetSearchCompleted (e, ui){
			$('#radioSearchGeneSet').prop('checked', true);
			showForm2LowerPart();
		}				
// 		$( "#textfieldGeneSet" ).on( "autocompleteselect", geneSetSearchCompleted);
// 		$( "#textfieldGeneSet" ).on( "autocompleteselect", geneSetSearchCompleted);
		
		document.getElementById("selectPathprint").addEventListener("change", changeRadioSelection);
		document.getElementById("selectMSigDBC2CP").addEventListener("change", changeRadioSelection);
		document.getElementById("selectMSigDBC5").addEventListener("change", changeRadioSelection);	
        document.getElementById("selectMSigDBH").addEventListener("change", changeRadioSelection);	
		
		function radioAnalysisClick (e) {
			if (e.target.id == "radioAnalysis1") {
				$("#form1").hide();
				$("#form2").show();	
				$("#extraOptions").hide();
				localStorage.setItem("explore", true);
				checkLocalStorage();		
			} else if (e.target.id == "radioAnalysis2") {
				$("#form2").hide();
				$("#form1").show();
				$("#extraOptions").show();
				localStorage.setItem("explore", false);
				checkLocalStorage();
				
			} else {
				alert("Error. Please contact W.Wei@sheffield.ac.uk");
			}
			$(".result").hide();
		}
		
		function form2RadioClick (e) {
			showForm2LowerPart();			
		}	
		
		function showForm2LowerPart () {
			$("#label1").show();
			$("#inputCorrelation2").show();
			$("#label2").show();
			$("#inputpValue2").show();
			$("#button4").show();
			$("#button3").show();
			$("#divShareButtons").show();
			$(".ui-helper-hidden-accessible").hide();	
		}	
		document.getElementById("radioAnalysis1").addEventListener("click", radioAnalysisClick);
		document.getElementById("radioAnalysis2").addEventListener("click", radioAnalysisClick);
		document.getElementById("radioPathprint").addEventListener("click", form2RadioClick);
		document.getElementById("radioMSigDBC2CP").addEventListener("click", form2RadioClick);
		document.getElementById("radioMSigDBC5").addEventListener("click", form2RadioClick);
        document.getElementById("radioMSigDBH").addEventListener("click", form2RadioClick);
		document.getElementById("radioSearchGeneSet").addEventListener("click", form2RadioClick);
		
		function coefficientSliderChange (e) {
			$("#coefficientText").val($("#coefficientSlider").val());
			if ($("#coefficientSlider").val() > maxCorrInResponseWithQuery) {
				alert("None of the edges connected to the query gene set(s) in the network has absolute correlation coefficient > " + $("#coefficientSlider").val() + ". Notwork has not been changed." ) ;
				$("#coefficientSlider").val(maxCorrInResponseWithQuery);
				$("#coefficientText").val($("#coefficientSlider").val());
				return;
			}
			$("#inputCorrelation").val($("#coefficientSlider").val());
			//javascript:send();
			corrCutOffValue = $("#coefficientSlider").val();
			handleFormResponse(formResponse);				
		}
		
		function coefficientSliderInput (e) {
			$("#coefficientText").val($("#coefficientSlider").val());						
		}
		
		function pvalueSliderChange (e) {
			$("#pvalueText").val($("#pvalueSlider").val());
			if ($("#pvalueSlider").val() < minPValueInResponseWithQuery) {
				alert("None of the edges connected to the query gene set(s) in the network has correlation p value < " + $("#pvalueSlider").val()) ;
			}
			$("#inputpValue").val($("#pvalueSlider").val());				
			//javascript:send();
			pCutOffValue =$("#pvalueSlider").val();
			handleFormResponse(formResponse);				
		}
		
		function pvalueSliderInput (e) {
			$("#pvalueText").val($("#pvalueSlider").val());	
		}
		
		document.getElementById("coefficientSlider").addEventListener("change", coefficientSliderChange);
		document.getElementById("coefficientSlider").addEventListener("input", coefficientSliderInput);
		document.getElementById("pvalueSlider").addEventListener("change", pvalueSliderChange);
		document.getElementById("pvalueSlider").addEventListener("input", pvalueSliderInput);
		
		function displayResults (){
            localStorage.setItem("checkboxHeatmap", document.getElementById("checkboxHeatmap").checked);
            localStorage.setItem("checkboxNetwork", document.getElementById("checkboxNetwork").checked);
            localStorage.setItem("checkboxGeneList", document.getElementById("checkboxGeneList").checked);
            localStorage.setItem("checkboxCorrelationTable", document.getElementById("checkboxCorrelationTable").checked);
			$("#divInput").find('*').hide();
			$("#divInput").hide();
			$("#divShareButtons").hide();
			$(".result").show();
			$("#navMenu").show();
				
			if (document.getElementById("checkboxHeatmap").checked) {
				$("#divHeatmap").parents().show();
				$("#divHeatmap").show();
				$("#divHeatmap").children().show();
			} else {
				$("#divHeatmap").children().hide();
				$("#divHeatmap").hide();
			}
				
			if (document.getElementById("checkboxNetwork").checked) {
				$("#divNetwork").parents().show();
				$("#divNetwork").show();
				$("#divNetwork").children().show();
				$("#netWorkHeadLabel").show();				
				$("#cy").show();
				$("#divSliders").show();
				$("#divSliders").children().show();			
			} else {
				$("#divNetwork").find('*').hide();
				$("#divNetwork").hide();
				$("#divSliders").hide();
				$("#divSliders").children().hide();
			}
								
			if (document.getElementById("checkboxGeneList").checked) {
				$("#divGeneList").parents().show();
				$("#divGeneList").show();
				$("#divGeneList").children().show();
				$("#table2waiting").hide();				
			} else {
				$("#divGeneList").children().hide();
				$("#divGeneList").hide();
			}
						
			if (document.getElementById("checkboxCorrelationTable").checked) {
				$("#divTable1").parents().show();
				$("#divTable1").show();
				$("#divTable1").children().show();
			} else {
				$("#divTable1").children().hide();
				$("#divTable1").hide();
			}
		}
		
		function checkboxNetworkClick (e) {
			if (document.getElementById("checkboxNetwork").checked) {
				handleFormResponse(formResponse);			
			} else {
				$("#divNetwork").children().hide();
				$("#divNetwork").hide();
				$("#divSliders").children().hide();
				$("#divSliders").hide();
			}
            localStorage.setItem("checkboxCorrelationTable", document.getElementById("checkboxCorrelationTable").checked);
		}
		
		document.getElementById("checkboxHeatmap").addEventListener("click", displayResults);
		document.getElementById("checkboxNetwork").addEventListener("click", checkboxNetworkClick);
// 		document.getElementById("checkboxNetworkLegend").addEventListener("click", displayResults);
		document.getElementById("checkboxGeneList").addEventListener("click", displayResults);
		document.getElementById("checkboxCorrelationTable").addEventListener("click", displayResults);
	</script>
</body>
</html>
